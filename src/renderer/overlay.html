<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>VerseCon Overlay</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        :root {
            --bg-glass: rgba(11, 12, 16, 0.6);
            --accent: #ffa500;
            --cyan: #00c8ff;
            --text-main: #e0e0e0;
            --text-dim: #8892b0;
            --success: #00ff88;
            --danger: #ff4444;
            --purple: #a855f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            font-family: 'Rajdhani', sans-serif;
            color: var(--text-main);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* ‚ïê‚ïê‚ïê DRAG HANDLE ‚ïê‚ïê‚ïê */
        .drag-handle {
            background: linear-gradient(90deg, rgba(255, 165, 0, 0.3), transparent);
            border: 1px solid rgba(255, 165, 0, 0.2);
            border-radius: 4px 4px 0 0;
            padding: 4px 10px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            user-select: none;
            -webkit-app-region: no-drag;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle .grip {
            font-size: 0.5rem;
            letter-spacing: 2px;
            color: var(--accent);
            opacity: 0.6;
        }

        .drag-handle .label {
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
        }

        .drag-handle .lock-btn {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            font-size: 0.6rem;
            padding: 1px 6px;
            border-radius: 3px;
            cursor: pointer;
        }

        .drag-handle .lock-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .drag-handle .lock-btn.locked {
            color: var(--danger);
            border-color: var(--danger);
        }

        /* ‚ïê‚ïê‚ïê HUD MODULES ‚ïê‚ïê‚ïê */
        .hud-module {
            background: var(--bg-glass);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-left: 3px solid var(--accent);
            padding: 10px 14px;
            margin-bottom: 6px;
            transform: skewX(-2deg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .hud-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-dim);
            margin-bottom: 3px;
        }

        .hud-value {
            font-size: 1.05rem;
            font-weight: 700;
            color: white;
        }

        /* Module accent colors */
        .hud-module.ship {
            border-left-color: var(--cyan);
        }

        .hud-module.party {
            border-left-color: var(--success);
        }

        .hud-module.cmd {
            border-left-color: var(--danger);
        }

        .hud-module.spawn {
            border-left-color: var(--purple);
        }

        .hud-module.server {
            border-left-color: #888;
        }

        /* Ship image */
        .ship-image {
            width: 100%;
            max-height: 80px;
            object-fit: contain;
            border-radius: 4px;
            margin-top: 5px;
            opacity: 0.85;
        }

        /* ‚ïê‚ïê‚ïê STATUS DOTS ‚ïê‚ïê‚ïê */
        .status-row {
            display: flex;
            gap: 8px;
            padding: 4px 10px;
            margin-bottom: 6px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ff4444;
            display: inline-block;
            margin-right: 4px;
            vertical-align: middle;
        }

        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 6px var(--success);
        }

        .status-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ‚ïê‚ïê‚ïê COMMAND DISPLAY ‚ïê‚ïê‚ïê */
        .active-command {
            background: rgba(255, 68, 68, 0.15);
            border: 1px solid rgba(255, 68, 68, 0.4);
            border-left: 3px solid var(--danger);
            padding: 10px;
            margin-bottom: 6px;
            animation: cmdPulse 2s ease-in-out infinite;
        }

        @keyframes cmdPulse {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(255, 68, 68, 0.2);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            }
        }

        .cmd-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--danger);
            text-transform: uppercase;
        }

        .cmd-from {
            font-size: 0.6rem;
            color: var(--text-dim);
        }

        .ack-btn {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 4px 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 5px;
            font-family: inherit;
        }

        .ack-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* ‚ïê‚ïê‚ïê PARTY MEMBERS ‚ïê‚ïê‚ïê */
        .party-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .party-member {
            font-size: 0.75rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ‚ïê‚ïê‚ïê FEED ENTRIES ‚ïê‚ïê‚ïê */
        .feed-entry {
            font-size: 0.65rem;
            color: var(--text-dim);
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .feed-entry .icon {
            margin-right: 4px;
        }

        /* ‚ïê‚ïê‚ïê ANIMATIONS ‚ïê‚ïê‚ïê */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Hidden by default */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Drag Handle -->
    <div class="drag-handle" id="dragHandle">
        <span class="grip">‚£ø‚£ø‚£ø</span>
        <span class="label">VerseCon HUD</span>
        <button class="lock-btn" id="lockBtn" title="Lock/Unlock position">üîì</button>
    </div>

    <!-- Connection Status -->
    <div class="status-row">
        <span><span class="status-dot" id="status-log"></span><span class="status-label">Log</span></span>
        <span><span class="status-dot" id="status-api"></span><span class="status-label">API</span></span>
        <span><span class="status-dot" id="status-game"></span><span class="status-label">Game</span></span>
    </div>

    <!-- Server Info -->
    <div class="hud-module server" id="mod-server">
        <div class="hud-label">Server</div>
        <div class="hud-value" id="val-server">‚Äî</div>
    </div>

    <!-- Current Ship -->
    <div class="hud-module ship" id="mod-ship">
        <div class="hud-label">Current Ship</div>
        <div class="hud-value" id="val-ship">On Foot</div>
        <img class="ship-image hidden" id="ship-img" alt="Ship">
    </div>

    <!-- Party / Crew -->
    <div class="hud-module party" id="mod-party">
        <div class="hud-label">Party <span id="party-count" style="color: var(--success);">(0)</span></div>
        <div class="party-list" id="party-list">
            <div style="color: var(--text-dim); font-size: 0.7rem;">Solo</div>
        </div>
    </div>

    <!-- Spawn Point -->
    <div class="hud-module spawn" id="mod-spawn">
        <div class="hud-label">Spawn Point</div>
        <div class="hud-value" id="val-spawn">Unknown</div>
    </div>

    <!-- Active Command -->
    <div class="active-command hidden" id="mod-command">
        <div class="hud-label">‚ö° Active Order</div>
        <div class="cmd-text" id="cmd-text">‚Äî</div>
        <div class="cmd-from" id="cmd-from"></div>
        <button class="ack-btn" id="ack-btn">ACK ‚úì</button>
    </div>

    <!-- Player Status (Critical) -->
    <div class="hud-module hidden" id="mod-alert" style="border-left-color: var(--danger);">
        <div class="hud-label">‚ö†Ô∏è Alert</div>
        <div class="hud-value" id="val-alert" style="color: var(--danger);">‚Äî</div>
    </div>

    <!-- Location -->
    <div class="hud-module">
        <div class="hud-label">Location</div>
        <div class="hud-value" id="val-location">‚Äî</div>
    </div>

    <!-- Recent Feed (mini) -->
    <div class="hud-module" style="padding: 6px 10px;">
        <div class="hud-label">Event Feed</div>
        <div id="feed-list" style="max-height: 100px; overflow-y: auto;"></div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        // State
        let currentShip = null;
        let shipImagePath = null;
        let partyMembers = [];
        let activeCommand = null;
        let isDragging = false;
        let isLocked = false;
        let dragOffset = { x: 0, y: 0 };

        // ‚ïê‚ïê‚ïê DRAG FUNCTIONALITY ‚ïê‚ïê‚ïê
        const dragHandle = document.getElementById('dragHandle');
        const lockBtn = document.getElementById('lockBtn');

        dragHandle.addEventListener('mousedown', (e) => {
            if (isLocked) return;
            isDragging = true;
            dragOffset.x = e.screenX;
            dragOffset.y = e.screenY;

            // Get current window position
            ipcRenderer.send('overlay:get-position');
        });

        let windowPos = { x: 0, y: 0 };
        ipcRenderer.on('overlay:position', (e, pos) => {
            windowPos = pos;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.screenX - dragOffset.x;
            const dy = e.screenY - dragOffset.y;
            ipcRenderer.send('overlay:move', {
                x: windowPos.x + dx,
                y: windowPos.y + dy
            });
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        lockBtn.addEventListener('click', () => {
            isLocked = !isLocked;
            lockBtn.textContent = isLocked ? 'üîí' : 'üîì';
            lockBtn.classList.toggle('locked', isLocked);
        });

        // ‚ïê‚ïê‚ïê FEED HELPER ‚ïê‚ïê‚ïê
        function addFeedEntry(icon, text) {
            const list = document.getElementById('feed-list');
            const entry = document.createElement('div');
            entry.className = 'feed-entry slide-in';
            entry.innerHTML = `<span class="icon">${icon}</span> ${text}`;
            list.insertBefore(entry, list.firstChild);
            // Keep max 15 entries
            while (list.children.length > 15) {
                list.removeChild(list.lastChild);
            }
        }

        // ‚ïê‚ïê‚ïê ACK BUTTON ‚ïê‚ïê‚ïê
        document.getElementById('ack-btn').addEventListener('click', () => {
            if (activeCommand) {
                ipcRenderer.send('command:ack', { id: activeCommand.id });
                document.getElementById('mod-command').classList.add('hidden');
                activeCommand = null;
                addFeedEntry('‚úÖ', 'Order acknowledged');
            }
        });

        // ‚ïê‚ïê‚ïê EVENT HANDLERS ‚ïê‚ïê‚ïê
        ipcRenderer.on('log:status', (e, data) => {
            document.getElementById('status-log').classList.toggle('online', data.connected);
        });

        ipcRenderer.on('api:status', (e, data) => {
            document.getElementById('status-api').classList.toggle('online', data.connected);
        });

        // Main game event handler
        ipcRenderer.on('log:update', (e, data) => {
            switch (data.type) {
                // Server
                case 'SERVER_ENV':
                    document.getElementById('val-server').textContent = data.value;
                    document.getElementById('status-game').classList.add('online');
                    break;

                case 'SESSION_ID':
                    // Append session to server display
                    const serverEl = document.getElementById('val-server');
                    if (serverEl.textContent !== '‚Äî') {
                        serverEl.textContent = serverEl.textContent.split(' ')[0] + ' üîó';
                    }
                    break;

                // Ship
                case 'SHIP_ENTER':
                    currentShip = data.value;
                    document.getElementById('val-ship').textContent = data.value;
                    const shipImg = document.getElementById('ship-img');
                    if (shipImagePath) {
                        shipImg.src = shipImagePath;
                        shipImg.classList.remove('hidden');
                    }
                    addFeedEntry('üöÄ', `Boarded: ${data.value}`);
                    break;

                case 'SHIP_EXIT':
                    currentShip = null;
                    document.getElementById('val-ship').textContent = 'On Foot';
                    document.getElementById('ship-img').classList.add('hidden');
                    addFeedEntry('üö∂', `Exited: ${data.value}`);
                    break;

                case 'SHIP_CURRENT':
                    currentShip = data.value;
                    document.getElementById('val-ship').textContent = data.value;
                    break;

                case 'VEHICLE_SPAWN':
                    addFeedEntry('üöÄ', `Vehicle spawned: ${data.value}`);
                    break;

                // Location
                case 'LOCATION':
                case 'LOCATION_HINT':
                    document.getElementById('val-location').textContent = data.value;
                    break;

                // Spawn
                case 'SPAWN_SET':
                case 'SPAWN_POINT':
                    document.getElementById('val-spawn').textContent = data.value;
                    addFeedEntry('üìç', `Spawn: ${data.value}`);
                    break;

                // Status alerts
                case 'STATUS':
                    const alertMod = document.getElementById('mod-alert');
                    const alertVal = document.getElementById('val-alert');
                    alertMod.classList.remove('hidden');

                    if (data.value === 'death') {
                        alertVal.textContent = '‚ò†Ô∏è DEATH';
                        alertVal.style.color = '#ff4444';
                        addFeedEntry('‚ò†Ô∏è', 'Death detected');
                    } else if (data.value === 'suffocating') {
                        alertVal.textContent = 'üå°Ô∏è SUFFOCATING';
                        alertVal.style.color = '#00c8ff';
                        addFeedEntry('üå°Ô∏è', 'Suffocating!');
                    } else if (data.value === 'depressurizing') {
                        alertVal.textContent = 'üí® DEPRESSURIZING';
                        alertVal.style.color = '#ffaa00';
                        addFeedEntry('üí®', 'Depressurizing');
                    }

                    // Auto-hide after 10s
                    setTimeout(() => {
                        alertMod.classList.add('hidden');
                    }, 10000);
                    break;

                // Zone
                case 'ZONE':
                    if (data.value === 'armistice_enter') {
                        addFeedEntry('üõ°Ô∏è', 'Entered Safe Zone');
                    } else if (data.value === 'armistice_leave') {
                        addFeedEntry('‚ö†Ô∏è', 'Leaving Armistice Zone!');
                    } else if (data.value === 'monitored_enter') {
                        addFeedEntry('üì°', 'Entered Monitored Space');
                    }
                    break;

                // Quantum
                case 'QUANTUM':
                    addFeedEntry(data.value === 'entered' ? 'üåå' : 'üõë', `Quantum ${data.value}`);
                    break;

                // Connection
                case 'CONNECTION':
                    document.getElementById('status-game').classList.toggle('online',
                        data.value === 'CONNECTED' || data.value === 'IN_GAME');
                    if (data.value === 'IN_GAME') addFeedEntry('üéÆ', 'Connected to game');
                    break;

                case 'GAME_JOIN':
                    document.getElementById('status-game').classList.add('online');
                    addFeedEntry('üéÆ', 'Joined game');
                    break;

                case 'GAME_LEAVE':
                    document.getElementById('status-game').classList.remove('online');
                    addFeedEntry('üö™', 'Left game');
                    break;

                case 'GAME_RESTART':
                    document.getElementById('status-game').classList.remove('online');
                    addFeedEntry('üîÑ', 'Game restarting...');
                    break;

                // Login
                case 'LOGIN':
                    addFeedEntry('üü¢', `Online: ${data.handle || 'Pilot'}`);
                    break;

                case 'PLAYER_NAME':
                    addFeedEntry('üë§', `Handle: ${data.value}`);
                    break;

                // Missions
                case 'MISSION':
                    const mIcons = { accepted: 'üìã', completed: '‚úÖ', failed: '‚ùå' };
                    addFeedEntry(mIcons[data.value] || 'üìã', `Mission ${data.value}`);
                    break;

                // Insurance
                case 'INSURANCE_CLAIM':
                    addFeedEntry('üõ°Ô∏è', 'Insurance claim filed');
                    break;

                // Docking
                case 'DOCKING':
                    addFeedEntry('üîó', `Docking ${data.value}`);
                    break;

                // Inventory
                case 'INVENTORY':
                    addFeedEntry(data.value === 'opened' ? 'üì¶' : 'üì¶', `Inventory ${data.value}`);
                    break;

                // Medical
                case 'MEDICAL_BED':
                    addFeedEntry('üè•', 'Medical bed entered');
                    break;

                // Party
                case 'PARTY_INVITE':
                    addFeedEntry('üì©', 'Party invite pending');
                    break;

                // Equipment
                case 'EQUIPMENT':
                    addFeedEntry('üéí', `${data.value.item.split('_')[0]} ‚Üí ${data.value.port}`);
                    break;
            }
        });

        // Command from server or local
        ipcRenderer.on('command:receive', (e, data) => {
            activeCommand = data;
            const cmdMod = document.getElementById('mod-command');
            cmdMod.classList.remove('hidden');
            document.getElementById('cmd-text').textContent = data.text || data.preset || 'ORDER';
            document.getElementById('cmd-from').textContent = data.from ? `from ${data.from}` : '';
            addFeedEntry('üì¢', data.text || data.preset);
        });

        ipcRenderer.on('command:sent', (e, data) => {
            addFeedEntry('üì¢', `Sent: ${data.text || data.preset}`);
        });

        // VerseCon events
        ipcRenderer.on('vcon:beacon', (e, data) => {
            addFeedEntry('üÜò', data.message || 'Beacon alert');
        });

        ipcRenderer.on('vcon:job', (e, data) => {
            addFeedEntry('üìú', data.message || 'Contract posted');
        });

        // Party updates
        ipcRenderer.on('api:party', (e, data) => {
            if (data.members) {
                partyMembers = data.members;
                const list = document.getElementById('party-list');
                const count = document.getElementById('party-count');
                count.textContent = `(${partyMembers.length})`;

                if (partyMembers.length === 0) {
                    list.innerHTML = '<div style="color: var(--text-dim); font-size: 0.7rem;">Solo</div>';
                } else {
                    list.innerHTML = partyMembers.map(m => `
                        <div class="party-member">
                            <span class="status-dot ${m.online ? 'online' : ''}"></span>
                            ${m.name || m.handle || 'Unknown'}
                        </div>
                    `).join('');
                }
            }
        });

        // v2.2 - Toast Notifications (Bypassing Feed)
        ipcRenderer.on('vcon:notification', (e, data) => {
            // data = { title, message, type: 'info|success|warning|error' }
            const iconMap = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };
            const icon = iconMap[data.type] || 'üîî';
            addFeedEntry(icon, `<span class="feed-highlight">${data.title}</span> ‚Äî ${data.message}`);
            playSound('notification');
        });

        // v2.2 - CRITICAL FIX: Listed for Broadcasted Commands via Alert Trigger
        ipcRenderer.on('alert:trigger', (e, data) => {
            if (data.type === 'COMMAND') {
                const cmdData = data.value;
                activeCommand = cmdData;
                const cmdMod = document.getElementById('mod-command');
                cmdMod.classList.remove('hidden');
                document.getElementById('cmd-text').textContent = cmdData.text || cmdData.preset || 'ORDER';
                document.getElementById('cmd-from').textContent = cmdData.from ? `from ${cmdData.from}` : '';
                addFeedEntry('üì¢', cmdData.text || cmdData.preset);

                // Auto-hide command after 15s
                setTimeout(() => {
                    cmdMod.classList.add('hidden');
                }, 15000);
            }
        });

        // Ship image setting from dashboard
        ipcRenderer.on('settings:ship-image', (e, path) => {
            shipImagePath = path;
            const img = document.getElementById('ship-img');
            if (currentShip && path) {
                img.src = path;
                img.classList.remove('hidden');
            }
        });

        // DND mode
        ipcRenderer.on('app:dnd', (e, data) => {
            // Could dim the overlay, etc.
        });
    </script>
</body>

</html>