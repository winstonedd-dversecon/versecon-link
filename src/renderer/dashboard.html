<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>VerseCon Link - Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        :root {
            --bg-deep: #0b0c10;
            --bg-panel: rgba(31, 40, 51, 0.6);
            --accent: #ffa500;
            --accent-glow: rgba(255, 165, 0, 0.4);
            --text-main: #e0e0e0;
            --text-dim: #8892b0;
            --border: rgba(255, 255, 255, 0.1);
            --danger: #ff4444;
            --success: #00ff88;
            --cyan: #00c8ff;
        }

        body {
            background: radial-gradient(circle at top right, #1f2833 0%, var(--bg-deep) 60%);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .title-bar-drag {
            -webkit-app-region: drag;
        }

        .no-drag {
            -webkit-app-region: no-drag;
        }

        /* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
        .sidebar {
            width: 260px;
            background: rgba(11, 12, 16, 0.9);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .brand {
            font-size: 1.6rem;
            font-weight: 700;
            color: white;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--accent-glow);
            border-left: 4px solid var(--accent);
            padding-left: 12px;
        }

        .menu-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            transform: translateX(3px);
        }

        .menu-item.active {
            background: linear-gradient(90deg, rgba(255, 165, 0, 0.2) 0%, transparent 100%);
            border-left: 3px solid var(--accent);
            color: var(--accent);
        }

        .badge {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }

        /* ‚ïê‚ïê‚ïê STATUS BOX ‚ïê‚ïê‚ïê */
        .status-box {
            margin-top: auto;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .status-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dim);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 5px currentColor;
        }

        .dot.on {
            background: var(--success);
            color: var(--success);
        }

        .dot.off {
            background: var(--danger);
            color: var(--danger);
        }

        /* ‚ïê‚ïê‚ïê MAIN AREA ‚ïê‚ïê‚ïê */
        .main {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        h2 {
            font-size: 1.4rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
        }

        .subtitle {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* ‚ïê‚ïê‚ïê FEED ‚ïê‚ïê‚ïê */
        .feed-container {
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 15px;
        }

        .feed-item {
            display: grid;
            grid-template-columns: 70px 36px 1fr;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            animation: slideIn 0.4s ease forwards;
            opacity: 0;
            transform: translateX(-10px);
        }

        .feed-time {
            font-family: monospace;
            color: var(--text-dim);
            font-size: 0.8rem;
        }

        .feed-icon {
            font-size: 1.1rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            width: 28px;
            height: 28px;
            line-height: 28px;
            border-radius: 5px;
        }

        .feed-text {
            font-size: 0.95rem;
            color: #ddd;
        }

        .feed-highlight {
            color: var(--accent);
            font-weight: 600;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.3);
        }

        /* ‚ïê‚ïê‚ïê CONTROLS ‚ïê‚ïê‚ïê */
        input.modern-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            font-family: inherit;
        }

        input.modern-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        button.cyber-btn {
            background: linear-gradient(45deg, #ffa500, #ff8800);
            color: #000;
            border: none;
            padding: 10px 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);
            cursor: pointer;
            transition: all 0.2s;
            -webkit-app-region: no-drag;
            font-family: inherit;
        }

        button.cyber-btn:hover {
            filter: brightness(1.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4);
        }

        button.cyber-btn.small {
            padding: 6px 10px;
            font-size: 0.75rem;
        }

        button.cyber-btn.danger {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }

        button.cyber-btn.success {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            color: #000;
        }

        /* ‚ïê‚ïê‚ïê COMMAND BUTTONS ‚ïê‚ïê‚ïê */
        .cmd-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .cmd-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 8px;
            cursor: pointer;
            text-align: center;
            color: var(--text-dim);
            transition: all 0.2s;
            font-family: inherit;
            font-size: 0.8rem;
        }

        .cmd-btn:hover {
            border-color: var(--accent);
            color: white;
            background: rgba(255, 165, 0, 0.1);
            transform: translateY(-2px);
        }

        .cmd-btn .cmd-icon {
            font-size: 1.4rem;
            display: block;
            margin-bottom: 4px;
        }

        /* ‚ïê‚ïê‚ïê UNKNOWN PATTERNS ‚ïê‚ïê‚ïê */
        .unknown-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 0.8rem;
            transition: background 0.2s;
        }

        .unknown-item:hover {
            background: rgba(255, 165, 0, 0.05);
        }

        .unknown-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unknown-key {
            flex: 1;
            color: var(--accent);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 0.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .unknown-sample {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #bbb;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 10px;
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .unknown-count {
            color: var(--text-dim);
            font-size: 0.7rem;
            min-width: 40px;
            text-align: right;
        }

        .unknown-actions {
            display: flex;
            gap: 4px;
        }

        .unknown-actions button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .unknown-actions button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .unknown-actions button.btn-ignore:hover {
            border-color: #ff4444;
            color: #ff4444;
        }

        /* ‚ïê‚ïê‚ïê ALERT COOLDOWN SLIDERS ‚ïê‚ïê‚ïê */
        .cooldown-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .cooldown-row label {
            font-size: 0.75rem;
            color: var(--text-dim);
            min-width: 120px;
        }

        .cooldown-row input[type=range] {
            flex: 1;
        }

        .cooldown-row .cooldown-val {
            font-size: 0.7rem;
            color: var(--accent);
            min-width: 30px;
            text-align: right;
        }

        /* ‚ïê‚ïê‚ïê COMMAND LOG ‚ïê‚ïê‚ïê */
        .cmd-log-item {
            padding: 8px 12px;
            border-left: 3px solid var(--accent);
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 6px 6px 0;
        }

        .cmd-log-from {
            font-size: 0.75rem;
            color: #888;
        }

        .cmd-log-text {
            font-size: 1rem;
            color: var(--accent);
            font-weight: 600;
        }

        .cmd-log-target {
            font-size: 0.75rem;
            color: var(--cyan);
        }

        .cmd-log-ack {
            font-size: 0.75rem;
            color: var(--success);
            margin-top: 2px;
        }

        /* ‚ïê‚ïê‚ïê TARGET SELECTOR ‚ïê‚ïê‚ïê */
        select.target-select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        select.target-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ‚ïê‚ïê‚ïê SECTION TITLE ‚ïê‚ïê‚ïê */
        .section-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 15px 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* ‚ïê‚ïê‚ïê SCROLLBAR ‚ïê‚ïê‚ïê */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Hide views by default */
        .view {
            display: none;
            flex-direction: column;
            flex: 1;
            padding: 25px;
            overflow: hidden;
        }

        .view.active {
            display: flex;
        }

        /* Mission List Styles */

        .mission-entry:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }

        .mission-entry.tracked {
            border-left: 2px solid var(--accent);
            padding-left: 8px;
            background: linear-gradient(90deg, rgba(255, 165, 0, 0.05), transparent);
        }
    </style>
</head>

<body>
    <div class="sidebar title-bar-drag">
        <div class="brand">VerseCon <span style="color:white; font-weight:300;">Link</span></div>

        <div class="menu-item active no-drag" id="nav-dashboard" onclick="switchTab('dashboard')">
            <span>üìä</span> Dashboard
        </div>
        <div class="menu-item no-drag" id="nav-vcon" onclick="switchTab('vcon')">
            <span>üåê</span> VerseCon Feed
        </div>
        <div class="menu-item no-drag" id="nav-command" onclick="switchTab('command')">
            <span>üì¢</span> Command
        </div>
        <div class="menu-item no-drag" id="nav-config" onclick="switchTab('config')">
            <span>‚öôÔ∏è</span> Settings
            <span class="badge" id="unknown-badge" style="display:none;">0</span>
        </div>
        <div class="menu-item no-drag" id="nav-players" onclick="switchTab('players')">
            <span>üë•</span> Players
        </div>
        <div class="menu-item no-drag" id="nav-logdb" onclick="switchTab('logdb')">
            <span>üóÑÔ∏è</span> Log Database
        </div>
        <div class="menu-item no-drag" onclick="toggleOverlay()">
            <span>üì∫</span> Toggle Overlay
        </div>

        <div style="flex:1"></div>

        <div style="margin-bottom: 15px;" class="no-drag">
            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 5px;">VERSECON AUTH</div>
            <div id="auth-ui-guest">
                <button class="cyber-btn no-drag" style="width:100%; margin:0;" onclick="openLogin()">Login with
                    VerseCon</button>
                <div style="font-size: 0.65rem; color: #555; margin-top: 4px; text-align: center;">Opens browser to
                    authenticate</div>
            </div>
            <div id="auth-ui-user"
                style="display:none; background: rgba(0,255,136,0.1); padding: 8px; border-radius: 6px; border: 1px solid #00ff88;">
                <div style="color: #00ff88; font-weight: bold; font-size: 0.85rem;">‚úì Authenticated</div>
                <div style="font-size: 0.65rem; color: #aaa;" id="auth-token-display">Session Active</div>
            </div>
        </div>

        <!-- MISSION TRACKER (New) -->
        <div class="status-box no-drag" id="mission-status-box"
            style="display:none; margin-bottom: 10px; border-color: var(--accent); max-height: 300px; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px">
                <div style="font-size:0.7rem; color:var(--accent); font-weight:700; letter-spacing:1px">ACTIVE CONTRACT
                </div>
                <div
                    style="font-size:0.6rem; background:rgba(255,165,0,0.2); color:orange; padding:1px 4px; border-radius:2px">
                    IN PROGRESS</div>
            </div>
            <div id="mission-title"
                style="font-weight:600; color:white; margin-bottom:8px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                -</div>

            <div style="font-size:0.65rem; color: #666; text-transform:uppercase; letter-spacing:0.5px">Objective</div>
            <div id="mission-objective" style="font-size:0.75rem; color:#ddd; line-height:1.2;">-</div>
        </div>

        <div class="status-box">
            <div class="status-row">
                <div class="status-label"><span class="dot off" id="status-log-dot"></span> Game Log</div>
                <span id="status-log-text" style="font-size:0.75rem;">Searching...</span>
            </div>
            <div class="status-row">
                <div class="status-label"><span class="dot off" id="status-api-dot"></span> API Link</div>
                <span id="status-api-text" style="font-size:0.75rem;">Disconnected</span>
            </div>
            <div class="status-row">
                <div class="status-label"><span class="dot off" id="status-twitch-dot"></span> Twitch Link</div>
                <span id="status-twitch-text" style="font-size:0.75rem;">Disconnected</span>
            </div>
            <div class="status-row">
                <div class="status-label"><span class="dot off" id="status-youtube-dot"></span> YouTube Link</div>
                <span id="status-youtube-text" style="font-size:0.75rem;">Disconnected</span>
            </div>
            <div class="status-row"
                style="margin-top:5px; padding-top:5px; border-top:1px solid rgba(255,255,255,0.05);">
                <div class="status-label" style="opacity:0.6;">Local Server</div>
                <span style="font-size:0.65rem; color:var(--accent);" id="sidebar-local-ip">---</span>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="view active" id="view-dashboard">
        <div class="header">
            <div>
                <h2 id="view-title">Dashboard</h2>
                <div class="subtitle" id="view-subtitle">Live system telemetry and mission feed</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;" class="no-drag">
                <!-- Friend Code display -->
                <div
                    style="background: rgba(255,165,0,0.1); border: 1px solid var(--accent); padding: 4px 10px; border-radius: 4px; display: flex; align-items: center; gap: 8px;">
                    <span
                        style="font-size: 0.7rem; color: var(--accent); text-transform: uppercase; font-weight: 700;">Friend
                        Code:</span>
                    <span id="display-friend-code"
                        style="font-family: monospace; font-weight: bold; color: #fff; letter-spacing: 1px;">------</span>
                    <button class="no-drag" onclick="copyFriendCode()"
                        style="background:none; border:none; color: var(--accent); cursor:pointer; padding: 2px;"
                        title="Copy Code">üìã</button>
                </div>

                <div class="no-drag" onclick="ipcRenderer.send('window:minimize')"></div>
            </div>
        </div>
        <div class="feed-container" id="event-feed">
            <div class="feed-item">
                <span class="feed-time">SYSTEM</span>
                <span class="feed-icon">‚úîÔ∏è</span>
                <span class="feed-text">System initialized. Waiting for Game.log stream...</span>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê NEW: LIVE RAW LOG FEED ‚ïê‚ïê‚ïê -->
        <div
            style="margin-top: 20px; flex: 1; display: flex; flex-direction: column; overflow: hidden; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h3
                        style="font-size: 0.9rem; color: #555; text-transform: uppercase; letter-spacing: 2px; margin: 0;">
                        Live Log Stream</h3>
                    <input type="text" id="raw-log-filter" class="modern-input" placeholder="Search logs..."
                        style="width: 200px; padding: 4px 8px; font-size: 0.8rem; margin: 0;" oninput="filterRawLogs()">
                </div>
                <span style="font-size: 0.7rem; color: #444;">Showing last 100 lines</span>
            </div>
            <div id="raw-log-list"
                style="flex: 1; overflow-y: auto; font-family: 'Consolas', 'Fira Code', 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; color: #aaa; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                <div style="color: #333; font-style: italic;">No log lines received yet...</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VERSECON FEED VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="view" id="view-vcon">
        <div class="header">
            <div>
                <h2>VerseCon Feed</h2>
                <div class="subtitle">Live contracts, beacons, operations & LFG from the platform</div>
            </div>
        </div>
        <div class="feed-container" id="vcon-feed">
            <div class="feed-item">
                <span class="feed-time">SYSTEM</span>
                <span class="feed-icon">üåê</span>
                <span class="feed-text">Connect to VerseCon to receive live platform updates...</span>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMMAND CENTER VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="view" id="view-command">
        <div class="header">
            <div>
                <h2>Command Center</h2>
                <div class="subtitle">Issue orders to teams and individuals</div>
            </div>
        </div>

        <div style="overflow-y: auto; flex:1;">
            <div class="section-title">Quick Orders</div>
            <div class="cmd-grid">
                <div class="cmd-btn" onclick="sendPresetCommand('RTB')"><span class="cmd-icon">üè†</span>RTB</div>
                <div class="cmd-btn" onclick="sendPresetCommand('DEFEND')"><span class="cmd-icon">üõ°Ô∏è</span>Defend</div>
                <div class="cmd-btn" onclick="sendPresetCommand('ENGAGE')"><span class="cmd-icon">üéØ</span>Engage</div>
                <div class="cmd-btn" onclick="sendPresetCommand('FALL BACK')"><span class="cmd-icon">‚¨ÖÔ∏è</span>Fall Back
                </div>
                <div class="cmd-btn" onclick="sendPresetCommand('REGROUP')"><span class="cmd-icon">üîÑ</span>Regroup
                </div>
                <div class="cmd-btn" onclick="sendPresetCommand('HOLD FIRE')"><span class="cmd-icon">‚úã</span>Hold Fire
                </div>
                <div class="cmd-btn" onclick="sendPresetCommand('ESCORT')"><span class="cmd-icon">üöÄ</span>Escort</div>
                <div class="cmd-btn" onclick="sendPresetCommand('COVER ME')"><span class="cmd-icon">üî•</span>Cover Me
                </div>
                <div class="cmd-btn" onclick="sendPresetCommand('ALL CLEAR')"><span class="cmd-icon">‚úÖ</span>All Clear
                </div>
                <div class="cmd-btn" onclick="sendPresetCommand('EMERGENCY')" style="border-color: var(--danger);"><span
                        class="cmd-icon">üÜò</span>SOS</div>
            </div>

            <div class="section-title">Custom Command</div>
            <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                <select class="target-select" id="cmd-target" style="min-width: 120px;">
                    <option value="ALL">üåê All Teams</option>
                    <option value="ALPHA">üè∑Ô∏è Alpha</option>
                    <option value="BRAVO">üè∑Ô∏è Bravo</option>
                    <option value="CHARLIE">üè∑Ô∏è Charlie</option>
                    <option value="DELTA">üè∑Ô∏è Delta</option>
                </select>
                <input class="modern-input" id="cmd-custom-text" placeholder="Type custom order..."
                    style="flex:1; margin:0;">
                <button class="cyber-btn" onclick="sendCustomCommand()" style="width:auto; margin:0;">Send</button>
            </div>
            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <label style="cursor: pointer; color: var(--text-dim); font-size: 0.8rem;">
                    <input type="checkbox" id="cmd-broadcast"> Broadcast to Overlay (Whole Screen)
                </label>
            </div>

            <div class="section-title">Command Log</div>
            <div class="feed-container" id="command-log" style="flex:1; min-height: 200px;">
                <div style="color: #555; font-style: italic; padding: 10px;">No commands issued yet...</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIGURATION VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="view" id="view-config">
        <div class="header">
            <div>
                <h2>Configuration</h2>
                <div class="subtitle">Settings, Log Path & Unknown Events</div>
            </div>
        </div>

        <div style="overflow-y: auto; flex:1;">
            <!-- Game Log Path -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Game Log Path</div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="config-log-path" class="modern-input" style="margin:0;" readonly
                        placeholder="No file selected">
                    <button class="cyber-btn" style="width: auto; margin:0;" onclick="selectLogFile()">Browse</button>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button class="cyber-btn small" onclick="window.location.reload()">üîÑ Reload App</button>
                </div>
            </div>

            <!-- Manual Token -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Manual Token (Legacy)</div>
                <div style="display: flex; gap: 8px;">
                    <input type="password" id="api-token-manual" class="modern-input"
                        placeholder="Paste token here if login fails" style="margin:0; flex:1;">
                    <button class="cyber-btn" style="width:auto; margin:0;" onclick="loginManual()">Set</button>
                </div>
            </div>

            <!-- Sound Settings -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Sound & Alerts</div>
                <div class="status-row">
                    <span style="color: var(--text-dim);">Alert Sounds</span>
                    <label style="cursor: pointer;"><input type="checkbox" id="sound-enabled" checked
                            onchange="toggleSounds()"> Enabled</label>
                </div>
                <div class="status-row">
                    <span style="color: var(--text-dim);">Volume</span>
                    <input type="range" id="sound-volume" min="0" max="100" value="70" style="width: 120px;"
                        oninput="updateVolume()">
                </div>
                <div class="status-row">
                    <span style="color: var(--text-dim);">HUD Warnings</span>
                    <label style="cursor: pointer;"><input type="checkbox" id="hud-warnings-enabled" checked>
                        Enabled</label>
                </div>
            </div>

            <!-- Alert Cooldowns -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Alert Cooldowns</div>
                <div style="font-size: 0.7rem; color: #666; margin-bottom: 10px;">Ignore repeated alerts within the
                    cooldown period (e.g., brief zone changes).</div>
                <div class="cooldown-row">
                    <label>Suffocating</label>
                    <input type="range" id="cd-suffocating" min="0" max="30" value="5"
                        oninput="updateCooldown('suffocating', this.value)">
                    <span class="cooldown-val" id="cd-suffocating-val">5s</span>
                </div>
                <div id="detected-ship-label"
                    style="display:none; margin-bottom: 10px; padding: 8px; background: rgba(0,255,100,0.1); border: 1px solid var(--accent); border-radius: 4px; color: #ccc;">
                </div>
                <div class="cooldown-row">
                    <label>Depressurizing</label>
                    <input type="range" id="cd-depressurizing" min="0" max="30" value="5"
                        oninput="updateCooldown('depressurizing', this.value)">
                    <span class="cooldown-val" id="cd-depressurizing-val">5s</span>
                </div>
            </div>

            <!-- Ship Image Manager (v2.2) -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Ship Image Manager</div>
                <div style="font-size: 0.7rem; color: #666; margin-bottom: 10px;">
                    Map ship names found in logs (e.g., "Clipper") to specific images.
                    <br>Partial matches work (e.g., "Clipper" matches "DRAK_Clipper").
                    <div style="margin-top: 5px; color: var(--accent);">
                        Last Detected: <span id="last-ship-debug"
                            style="color: #666; font-family: monospace;">Waiting...</span>
                    </div>
                </div>

                <div id="ship-map-list"
                    style="margin-bottom: 10px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px;">
                    <!-- Items: <div class="map-item">[Name] [Path] [X]</div> -->
                    <div style="padding: 10px; font-style: italic; color: #555; text-align: center;">No mappings set.
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-ship-name" class="modern-input" placeholder="Ship Name (e.g. Clipper)"
                        style="margin:0; flex:1;">
                    <button class="cyber-btn" style="width: auto; margin:0;" onclick="selectNewShipImage()">Select
                        Image</button>
                    <button class="cyber-btn" style="width: auto; margin:0;" onclick="addShipMapping()">Add
                        Mapping</button>
                </div>
                <input type="hidden" id="new-ship-image-path">
                <div id="new-ship-preview-label"
                    style="font-size: 0.75rem; color: var(--accent); margin-top: 5px; display: none;">Selected: <span
                        id="new-ship-filename"></span></div>
            </div>



            <!-- Built-in Pattern Manager (v2.2) -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Built-in Pattern Manager</div>
                <div style="font-size: 0.7rem; color: #666; margin-bottom: 10px;">
                    Modify or disable system log patterns. <b>‚ö†Ô∏è Expert Use Only</b> - Breaking these may stop game
                    state
                    updates.
                </div>
                <div class="section-title" style="margin-top: 20px;">Pattern Generator (Beta)</div>
                <div
                    style="background: rgba(0,0,0,0.3); padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,0.05); margin-bottom: 20px;">
                    <div style="font-size:0.75rem; color:#aaa; margin-bottom:5px;">Paste a raw log line below to
                        generate a regex:</div>
                    <input type="text" id="pattern-gen-input" class="modern-input"
                        style="width:100%; font-family:monospace; font-size:0.75rem; margin-bottom:8px;"
                        placeholder="<2026...> Event::Type - Value...">

                    <div style="display:flex; gap:10px;">
                        <button class="cyber-btn small" onclick="generatePattern()">‚ú® Generate Regex</button>
                        <input type="text" id="pattern-gen-output" class="modern-input"
                            style="flex:1; font-family:monospace; color:var(--accent);" placeholder="Regex output..."
                            readonly>
                        <button class="cyber-btn small icon" onclick="copyGeneratedPattern()"
                            title="Copy to Clipboard">üìã</button>
                    </div>
                </div>

                <div id="builtin-pattern-list"
                    style="margin-bottom: 10px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px;">
                    <div style="padding: 10px; text-align: center; color: #555;">Loading patterns...</div>
                </div>
                <div style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="cyber-btn danger" style="width: auto;" onclick="resetPatternOverrides()">Reset
                        All</button>
                    <button class="cyber-btn" style="width: auto;" onclick="loadBuiltinPatterns()">Reload</button>
                    <button class="cyber-btn" style="width: auto;" onclick="savePatternOverrides()">Save
                        Overrides</button>
                </div>
            </div>

            <!-- Custom Location Manager -->
            <div class="config-section" style="margin-top: 20px;">
                <div class="section-title">
                    <span>üìç Custom Locations</span>
                    <button class="cyber-btn small" onclick="addCustomLocationPrompt()" style="font-size: 0.7rem;">+ Add
                        New</button>
                    <button class="cyber-btn small" onclick="openLocationSearch()"
                        style="font-size: 0.7rem; margin-left: 5px;">üîç Search</button>
                    <!-- Help tooltip -->
                    <span style="font-size:0.7rem; color:#666; margin-left:10px; cursor:help;"
                        onclick="alert('Map raw log values (e.g. OOC_Stanton_1b_Aberdeen) to friendly names (e.g. Vivere PAF-1).\nWorks with Location[...] and RoomName: logs.')">‚ÑπÔ∏è
                        Help</span>
                </div>
                <div class="config-desc">
                    Map raw log codes to friendly location names.
                </div>

                <div
                    style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 10px; margin-top: 10px;">
                    <!-- Add New Inline Form -->
                    <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                        <input type="text" id="new-loc-key" placeholder="Raw Code (e.g. OOC_Stanton_...)"
                            class="modern-input" style="flex:1;">
                        <span style="color:#666;">‚ûî</span>
                        <input type="text" id="new-loc-val" placeholder="Friendly Name" class="modern-input"
                            style="flex:1;">
                        <select id="new-loc-zone" class="modern-input" style="width:120px; font-size:0.75rem;">
                            <option value="Auto">Auto Zone</option>
                            <option value="Armistice Zone">Armistice</option>
                            <option value="Open Space">Open Space</option>
                        </select>
                        <button class="cyber-btn small" onclick="saveNewCustomLocation()"
                            style="margin:0;">Save</button>
                    </div>

                    <!-- List -->
                    <div id="custom-location-list"
                        style="max-height: 200px; overflow-y: auto; display:flex; flex-direction:column; gap:5px;">
                        <div style="color:#666; font-style:italic; padding:10px; text-align:center;">No custom locations
                            set.</div>
                    </div>

                    <!-- Location Sniffer (v2.6) -->
                    <div id="location-sniffer"
                        style="margin-top: 15px; padding: 10px; background: rgba(0,255,136,0.05); border: 1px dashed var(--success); border-radius: 4px;">
                        <div
                            style="font-size: 0.7rem; color: var(--success); opacity: 0.7; text-transform: uppercase; margin-bottom: 5px;">
                            Last Detected Raw Location
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="last-raw-location"
                                style="font-family: monospace; font-size: 0.85rem; color: #fff;">None Detected</span>
                            <button class="cyber-btn small" onclick="grabRawLocation()"
                                style="width: auto; margin: 0;">Grab</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Remote Access (v2.9) -->
            <div
                style="background: rgba(170,100,255,0.1); padding: 15px; border-radius: 8px; border: 1px solid #aa64ff; margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <div style="font-weight:bold; color:#aa64ff;">Remote Control Access</div>
                    <button class="cyber-btn small" style="margin:0; width:auto; padding: 2px 8px; font-size:0.6rem;"
                        onclick="refreshLocalIP()">Refresh IP</button>
                </div>
                <div style="font-size:0.75rem; color:#888; margin-bottom:10px;">
                    Control your cockpit from a phone or tablet. Connect to this URL on your local network:
                </div>
                <div
                    style="background:rgba(0,0,0,0.3); padding:8px; border-radius:4px; font-family:monospace; font-size:0.85rem; color:#fff; text-align:center;">
                    http://<span id="local-ip">SEARCHING...</span>:4400/remote.html
                </div>
            </div>

            <!-- Stream Deck API (v2.10) -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Stream Deck & External API</div>
                <div style="font-size: 0.7rem; color: #888; margin-bottom: 10px;">
                    For manual control via Stream Deck or custom hardware.
                </div>

                <div style="font-size: 0.65rem; color: var(--text-dim); margin-bottom: 5px;">STREAM DECK BUTTONS</div>
                <div
                    style="background:rgba(0,0,0,0.2); padding:5px; border-radius:4px; font-family:monospace; font-size:0.7rem; margin-bottom:10px; line-height:1.4;">
                    POST /api/streamdeck/send-command<br>
                    { "preset": "RTB", "target": "ALL" }<br>
                    <br>
                    POST /api/streamdeck/tts<br>
                    { "text": "Message here" }<br>
                    <br>
                    GET /api/streamdeck/buttons<br>
                    (Returns all available Stream Deck commands)
                </div>

                <div style="font-size: 0.65rem; color: var(--text-dim); margin-bottom: 5px;">TACTICAL COMMANDS (POST)
                </div>
                <div
                    style="background:rgba(0,0,0,0.2); padding:5px; border-radius:4px; font-family:monospace; font-size:0.7rem; margin-bottom:10px;">
                    /api/control/command <br>
                    { "preset": "SITREP", "target": "ALL" }
                </div>
                <div style="font-size: 0.65rem; color: var(--text-dim); margin-bottom: 5px;">VISUAL ALERTS (POST)</div>
                <div
                    style="background:rgba(0,0,0,0.2); padding:5px; border-radius:4px; font-family:monospace; font-size:0.7rem;">
                    /api/control/vfx <br>
                    { "type": "interdiction" }
                </div>
            </div>

            <!-- HUD Customization (v2.8) -->
            <div
                style="background: rgba(0,100,255,0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--cyan); margin-bottom: 15px;">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <div style="font-weight:bold; color:#00c8ff;">Unlock HUD Layout</div>
                        <div style="font-size:0.8rem; color:#888;">Enable dragging of overlay elements (Flight Deck,
                            Feed)
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="config-unlock-hud" onchange="toggleHUDLock(this.checked)">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <!-- Smart Home ‚Äî Philips Hue (v2.9) -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0; display:flex; justify-content:space-between;">
                    <span>Smart Home ‚Äî Philips Hue</span>
                    <label class="switch" style="transform: scale(0.7); margin-top: -5px;">
                        <input type="checkbox" id="config-hue-enabled" onchange="saveConfig()">
                        <span class="slider round"></span>
                    </label>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <div style="flex:1;">
                        <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:2px;">BRIDGE IP</div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="config-hue-bridge" class="modern-input" style="margin:0;"
                                placeholder="192.168.1.x">
                            <button class="cyber-btn small" onclick="discoverHueBridge()"
                                style="margin:0; width:auto;">Discover</button>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:2px;">API USERNAME</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="config-hue-user" class="modern-input" style="margin:0;"
                            placeholder="Hue API Token">
                        <button class="cyber-btn small" onclick="linkHueBridge()" style="margin:0; width:auto;"
                            title="Press physical button on Bridge first!">Link</button>
                    </div>
                </div>

                <div style="margin-bottom: 10px;">
                    <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:2px;">LIGHT IDS (Comma Separated)
                    </div>
                    <input type="text" id="config-hue-lights" class="modern-input" style="margin:0;"
                        placeholder="1, 2, 5">
                </div>

                <button class="cyber-btn small" onclick="testHueLights()">Test Connection</button>
            </div>

            <!-- Location Sharing (Phase 5) -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <div style="font-weight:bold; color:#fff;">Wait for Signal</div>
                        <div style="font-size:0.8rem; color:#888;">Broadcast location to friends via VerseCon Relay
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="config-share-location" onchange="saveConfig()">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <!-- Team Designations (v2.8) -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Team Designations</div>
                <div style="font-size: 0.7rem; color: #666; margin-bottom: 10px;">
                    Rename your squadron's callsigns and assign yourself to a team.
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:2px;">TEAM 1</div>
                        <input type="text" id="team-name-0" class="modern-input" style="margin:0;"
                            onchange="saveTeamNames()">
                    </div>
                    <div>
                        <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:2px;">TEAM 2</div>
                        <input type="text" id="team-name-1" class="modern-input" style="margin:0;"
                            onchange="saveTeamNames()">
                    </div>
                    <div>
                        <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:2px;">TEAM 3</div>
                        <input type="text" id="team-name-2" class="modern-input" style="margin:0;"
                            onchange="saveTeamNames()">
                    </div>
                    <div>
                        <div style="font-size:0.6rem; color:var(--text-dim); margin-bottom:2px;">TEAM 4</div>
                        <input type="text" id="team-name-3" class="modern-input" style="margin:0;"
                            onchange="saveTeamNames()">
                    </div>
                </div>

                <div
                    style="display:flex; align-items:center; justify-content:space-between; padding-top:10px; border-top: 1px solid rgba(255,255,255,0.05);">
                    <div>
                        <div style="font-weight:bold; color:#fff;">Your Assigned Team</div>
                        <div style="font-size:0.8rem; color:#888;">Identify yourself in command transmissions</div>
                    </div>
                    <select id="config-user-team" class="modern-input" style="width:120px; margin:0;"
                        onchange="saveConfig()">
                        <option value="Alpha">Alpha</option>
                        <option value="Bravo">Bravo</option>
                        <option value="Charlie">Charlie</option>
                        <option value="Delta">Delta</option>
                    </select>
                </div>
            </div>

            <!-- Manual Log Patterns (v2.2) -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;">
                <div class="section-title" style="margin-top: 0;">Manual Log Patterns</div>
                <div style="font-size: 0.7rem; color: #666; margin-bottom: 10px;">
                    Define custom Regex patterns to trigger alerts. Capture groups can be used as values.
                </div>

                <div id="pattern-list"
                    style="margin-bottom: 10px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 4px;">
                    <div style="padding: 10px; font-style: italic; color: #555; text-align: center;">No custom patterns
                        defined.</div>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="new-pattern-regex" class="modern-input"
                        placeholder="Regex (e.g. /Time: (\d+)%)" style="flex:2; margin:0;">
                    <select id="new-pattern-level" class="modern-input" style="flex:1; margin:0; padding: 0 5px;">
                        <option value="INFO">Info (Blue)</option>
                        <option value="WARN">Warning (Orange)</option>
                        <option value="CRITICAL">Critical (Red/Flash)</option>
                    </select>
                    <select id="new-pattern-hue" class="modern-input" style="flex:1; margin:0; padding: 0 5px;">
                        <option value="">Hue: None</option>
                        <option value="red">Hue: Red</option>
                        <option value="orange">Hue: Orange</option>
                        <option value="blue">Hue: Blue</option>
                        <option value="green">Hue: Green</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-pattern-msg" class="modern-input"
                        placeholder="Alert Message (Use $1 for value)" style="flex:1; margin:0;">
                    <button id="btn-add-pattern" class="cyber-btn" style="width: auto; margin:0;"
                        onclick="addCustomPattern()">Add
                        Pattern</button>
                </div>
            </div>

            <!-- Unknown Log Discovery -->
            <div
                style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="section-title" style="margin-top: 0; border-bottom: none;">Unknown Log Events <span
                            id="unknown-count-label" style="color: var(--accent);">(0)</span></div>
                    <div style="display: flex; gap: 6px;">
                        <button class="cyber-btn small" onclick="refreshUnknowns()">Refresh</button>
                        <button class="cyber-btn small danger" onclick="clearUnknowns()">Clear All</button>
                    </div>
                </div>
                <div style="font-size: 0.75rem; color: #666; margin-bottom: 10px;">
                    Unmatched log events appear here. <b>üìã Copy</b> the sample to analyze, or <b>üö´ Ignore</b> to hide.
                </div>
                <div class="feed-container" id="unknown-list" style="max-height: 400px; padding: 0;">
                    <div style="color: #555; font-style: italic; padding: 15px; text-align: center;">No unknown patterns
                        detected yet. Play the game to discover new log events.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLAYERS VIEW (Phase 10) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="view-players" class="view">
        <div
            style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; border: 1px solid var(--border); flex: 1; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin:0; color:var(--accent);">SOCIAL HUB</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="add-friend-code" placeholder="Enter Friend Code" class="modern-input"
                        style="width: 150px; margin:0;">
                    <button class="cyber-btn" onclick="addFriendByCode()">Add Friend</button>
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto;">
                <div id="friend-list">
                    <div style="color:#666; font-style:italic; text-align:center; padding: 40px;">No friends found. Add
                        someone to start sharing telemetry.</div>
                </div>
            </div>

            <div
                style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <div style="color: var(--text-dim); font-size: 0.8rem;">
                    Friends can see your location and status if "Wait for Signal" is enabled.
                </div>
                <button class="cyber-btn small no-drag"
                    onclick="shell.openExternal('https://versecon.space/groups')">Discover Groups</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOG DATABASE VIEW (v2.7) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="view-logdb" class="view">
        <!-- Toolbar -->
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; align-items:center;">
            <input type="text" id="logdb-search" placeholder="Search patterns..." class="modern-input"
                style="flex:1; min-width:200px; margin:0;" oninput="filterPatternDB()">
            <select id="logdb-category" class="modern-input" style="width:130px; margin:0;"
                onchange="filterPatternDB()">
                <option value="">All Categories</option>
            </select>
            <select id="logdb-status" class="modern-input" style="width:120px; margin:0;" onchange="filterPatternDB()">
                <option value="">All Status</option>
                <option value="verified">‚úÖ Verified</option>
                <option value="research">üî¨ Research</option>
            </select>
            <button class="cyber-btn small" onclick="showAddPatternModal()" style="margin:0;">+ Add</button>
            <button class="cyber-btn small" onclick="exportPatternDB()" style="margin:0;">üì§ Export</button>
            <button class="cyber-btn small" onclick="importPatternDB()" style="margin:0;">üì• Import</button>
        </div>

        <!-- Stats bar -->
        <div style="display:flex; gap:15px; margin-bottom:15px; font-size:0.75rem; color:#888;">
            <span>Total: <b id="logdb-total" style="color:var(--accent);">0</b></span>
            <span>Verified: <b id="logdb-verified" style="color:#00ff88;">0</b></span>
            <span>Research: <b id="logdb-research" style="color:#ffaa00;">0</b></span>
            <span>Last Updated: <b id="logdb-updated" style="color:#aaa;">‚Äî</b></span>
        </div>

        <!-- Pattern List -->
        <div id="logdb-list" class="feed-container"
            style="max-height: calc(100vh - 240px); padding:0; overflow-y:auto;">
            <div style="color:#555; font-style:italic; padding:30px; text-align:center;">
                Loading pattern database...
            </div>
        </div>
    </div>

    <!-- Log DB Add/Edit Modal -->
    <div id="logdb-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.8); z-index:9999; display:none; align-items:center; justify-content:center;">
        <div
            style="background:#1a1a2e; border:1px solid var(--accent); border-radius:8px; padding:20px; width:500px; max-height:80vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--accent);" id="logdb-modal-title">Add Pattern</h3>
                <button class="cyber-btn small danger" onclick="closePatternModal()" style="margin:0;">‚úï</button>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Name</label>
                        <input type="text" id="pm-name" class="modern-input" placeholder="Ship Enter (VOIP)"
                            style="margin:0;">
                    </div>
                    <div style="width:130px;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Category</label>
                        <select id="pm-category" class="modern-input" style="margin:0;">
                            <option>Vehicle</option>
                            <option>Navigation</option>
                            <option>Combat</option>
                            <option>Mission</option>
                            <option>Economy</option>
                            <option>Hazard</option>
                            <option>Session</option>
                            <option>Fire</option>
                            <option>Inventory</option>
                            <option>Social</option>
                            <option>VOIP</option>
                            <option>Industrial</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Event Type</label>
                        <input type="text" id="pm-event" class="modern-input" placeholder="SHIP_ENTER"
                            style="margin:0;">
                    </div>
                    <div style="width:130px;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Status</label>
                        <select id="pm-status" class="modern-input" style="margin:0;">
                            <option value="research">üî¨ Research</option>
                            <option value="verified">‚úÖ Verified</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Regex Pattern</label>
                    <input type="text" id="pm-regex" class="modern-input"
                        style="margin:0; font-family:monospace; color:#aaffaa;"
                        placeholder="SHUDEvent_OnNotification.*You have joined channel '(.+?)'">
                </div>

                <div>
                    <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Example Log Line</label>
                    <input type="text" id="pm-example" class="modern-input"
                        style="margin:0; font-family:monospace; font-size:0.75rem;"
                        placeholder="<SHUDEvent_OnNotification> You have joined channel 'Prowler : Player'">
                </div>

                <!-- Regex Tester -->
                <div
                    style="background:rgba(0,0,0,0.3); padding:8px; border-radius:4px; border:1px solid rgba(255,255,255,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.7rem; color:#888; text-transform:uppercase;">Regex Test Result</span>
                        <button class="cyber-btn small" onclick="testPatternRegex()"
                            style="margin:0; font-size:0.7rem;">‚ñ∂ Test</button>
                    </div>
                    <div id="pm-test-result"
                        style="font-family:monospace; font-size:0.75rem; color:#666; margin-top:5px; word-break:break-all;">
                        Click Test to verify regex against example
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">üé® Hue Effect</label>
                        <select id="pm-hue" class="modern-input" style="margin:0;">
                            <option value="none">None</option>
                            <option value="red">üî¥ Red (Critical)</option>
                            <option value="orange">üü† Orange (Warning)</option>
                            <option value="blue">üîµ Blue (Info)</option>
                            <option value="green">üü¢ Green (Success)</option>
                            <option value="purple">üü£ Purple (Special)</option>
                            <option value="cyan">ü©µ Cyan (System)</option>
                            <option value="white">‚ö™ White (Flash)</option>
                            <option value="yellow">üü° Yellow (Caution)</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">üì∫ Overlay Effect</label>
                        <select id="pm-overlay" class="modern-input" style="margin:0;">
                            <option value="none">None</option>
                            <option value="feed">üìú Feed Entry Only</option>
                            <option value="alert">‚ö†Ô∏è Alert Popup</option>
                            <option value="both">üî• Both (Feed + Alert)</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">üñ•Ô∏è HUD Alert
                            Type</label>
                        <select id="pm-alert" class="modern-input" style="margin:0;">
                            <option value="none">None</option>
                            <option value="audio">üîä Audio Only</option>
                            <option value="visual">üì∫ Visual Only</option>
                            <option value="both">üî• Both (Critical)</option>
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">HUD Warning
                            Message</label>
                        <input type="text" id="pm-warning" class="modern-input" placeholder="Wasted / Hull Breach / etc"
                            style="margin:0;">
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Reaction (TTS or
                            Cmd)</label>
                        <input type="text" id="pm-reaction" class="modern-input"
                            placeholder="TTS: Fire detected / /emergency" style="margin:0;">
                    </div>
                </div>

                <div>
                    <label style="font-size:0.7rem; color:#888; text-transform:uppercase;">Notes</label>
                    <textarea id="pm-notes" class="modern-input" rows="2" style="margin:0; resize:vertical;"
                        placeholder="Additional context about this pattern..."></textarea>
                </div>

                <input type="hidden" id="pm-edit-id">
                <button class="cyber-btn" onclick="savePatternFromModal()" style="margin-top:5px;">üíæ Save
                    Pattern</button>
            </div>
        </div>
    </div>

    <!-- Custom Location Search & Edit Modal (NEW) -->
    <div id="location-search-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
        <div
            style="background:#1a1a2e; border:1px solid var(--accent); border-radius:8px; padding:20px; width:600px; max-height:80vh; overflow-y:auto; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--accent);">Search & Edit Stations</h3>
                <button class="cyber-btn small danger" onclick="closeLocationSearchModal()" style="margin:0;">‚úï</button>
            </div>

            <!-- Search Bar -->
            <div style="display:flex; gap:8px; margin-bottom:15px;">
                <input type="text" id="location-search-input" class="modern-input"
                    placeholder="Search by raw code or friendly name..." style="flex:1; margin:0;"
                    oninput="filterLocationSearch()">
                <button class="cyber-btn small" onclick="clearLocationSearch()" style="margin:0;">Clear</button>
            </div>

            <!-- Results Count -->
            <div style="font-size:0.7rem; color:var(--text-dim); margin-bottom:10px;">
                <span id="location-search-count">0</span> locations found
            </div>

            <!-- Location List -->
            <div id="location-search-results"
                style="flex:1; overflow-y:auto; background:rgba(0,0,0,0.3); border-radius:4px; border:1px solid rgba(255,255,255,0.05); padding:10px; margin-bottom:15px;">
                <div style="color:#666; font-style:italic; text-align:center; padding:20px;">No locations yet. Add one
                    using the form above.</div>
            </div>

            <!-- Selected Location Edit Panel -->
            <div id="location-edit-panel"
                style="display:none; background:rgba(255,165,0,0.1); border:1px solid var(--accent); border-radius:4px; padding:12px; margin-bottom:10px;">
                <div style="font-size:0.7rem; color:var(--accent); text-transform:uppercase; margin-bottom:8px;">
                    ‚úèÔ∏è Edit Selected Location
                </div>
                <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                    <input type="text" id="location-edit-key" class="modern-input" readonly placeholder="Raw Code"
                        style="flex:1; margin:0; opacity:0.7;">
                    <span style="color:#666; align-self:center;">‚ûî</span>
                    <input type="text" id="location-edit-val" class="modern-input" placeholder="Friendly Name"
                        style="flex:1; margin:0;">
                    <select id="location-edit-zone" class="modern-input"
                        style="width:110px; font-size:0.75rem; margin:0;">
                        <option value="Auto">Auto Zone</option>
                        <option value="Armistice Zone">Armistice</option>
                        <option value="Open Space">Open Space</option>
                    </select>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="cyber-btn small success" onclick="saveLocationEdit()" style="flex:1; margin:0;">
                        üíæ Update
                    </button>
                    <button class="cyber-btn small danger" onclick="deleteSelectedLocation()" style="flex:1; margin:0;">
                        üóëÔ∏è Delete
                    </button>
                    <button class="cyber-btn small" onclick="cancelLocationEdit()"
                        style="flex:1; margin:0;">Cancel</button>
                </div>
            </div>

            <input type="hidden" id="location-edit-original-key">
        </div>
    </div>

    <!-- Audio Synthesizer -->
    <script src="audio-synth.js"></script>

    <script>
        const { ipcRenderer } = require('electron');

        // ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
        let soundEnabled = true;
        let soundVolume = 0.7;
        let unknownCount = 0;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // ‚ïê‚ïê‚ïê TAB SWITCHING ‚ïê‚ïê‚ïê
        function switchTab(tab) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));

            document.getElementById(`nav-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).classList.add('active');

            // Update header title
            const titles = {
                'dashboard': ['Dashboard', 'Live system telemetry and mission feed'],
                'vcon': ['VerseCon Feed', 'Platform-wide contracts, beacons and trades'],
                'command': ['Command Console', 'Battlefield C2 and quick orders'],
                'config': ['Settings', 'Application configuration and log patterns'],
                'players': ['Social Hub', 'Manage friends and shared telemetry'],
                'logdb': ['Log Database', 'Known Star Citizen log patterns ‚Äî browse, edit, export']
            };

            // Auto-load patterns when switching to logdb
            if (tab === 'logdb') loadPatternDB();

            if (titles[tab]) {
                document.getElementById('view-title').innerText = titles[tab][0];
                document.getElementById('view-subtitle').innerText = titles[tab][1];
            }
        }

        // ‚ïê‚ïê‚ïê SOUND SYSTEM (v3 Synthesizer) ‚ïê‚ïê‚ïê
        function playSound(type) {
            if (!soundEnabled) return;
            try {
                const volElem = document.getElementById('sound-volume');
                const vol = (volElem ? volElem.value : 50) / 100;

                if (window.audioSynth) {
                    window.audioSynth.setVolume(vol);
                    window.audioSynth.play(type);
                }
            } catch (e) {
                console.warn('Sound failed:', e);
            }
        }

        function toggleSounds() {
            soundEnabled = document.getElementById('sound-enabled').checked;
            saveConfig();
        }

        function updateVolume() {
            soundVolume = document.getElementById('sound-volume').value / 100;
            saveConfig();
        }

        // ‚ïê‚ïê‚ïê CONFIG MANAGEMENT ‚ïê‚ïê‚ïê
        function saveConfig() {
            const config = {
                logPath: document.getElementById('config-log-path').value,
                volume: document.getElementById('sound-volume').value,
                soundEnabled: document.getElementById('sound-enabled').checked,
                // overlayEnabled if exists
                shareLocation: document.getElementById('config-share-location').checked,
                hueEnabled: document.getElementById('config-hue-enabled')?.checked,
                hueBridge: document.getElementById('config-hue-bridge')?.value,
                hueUser: document.getElementById('config-hue-user')?.value,
                hueLights: document.getElementById('config-hue-lights')?.value ? document.getElementById('config-hue-lights').value.split(',').map(l => l.trim()) : undefined
            };
            // Handle optional elements
            const overlayEl = document.getElementById('config-overlay-enabled');
            if (overlayEl) config.overlayEnabled = overlayEl.checked;

            const autoCleanEl = document.getElementById('config-auto-clean');
            if (autoCleanEl) config.autoCleanMissions = autoCleanEl.checked;

            ipcRenderer.send('settings:save', config);
        }

        ipcRenderer.on('settings:updated', (e, config) => {
            // Update UI from config
            if (config.volume) document.getElementById('sound-volume').value = config.volume;
            if (config.soundEnabled !== undefined) document.getElementById('sound-enabled').checked = config.soundEnabled;
            if (config.shareLocation !== undefined) document.getElementById('config-share-location').checked = config.shareLocation;

            // Hue Settings
            if (config.hueEnabled !== undefined) {
                const hueEnabledEl = document.getElementById('config-hue-enabled');
                if (hueEnabledEl) hueEnabledEl.checked = config.hueEnabled;
            }
            if (config.hueBridge !== undefined) {
                const hueBridgeEl = document.getElementById('config-hue-bridge');
                if (hueBridgeEl) hueBridgeEl.value = config.hueBridge;
            }
            if (config.hueUser !== undefined) {
                const hueUserEl = document.getElementById('config-hue-user');
                if (hueUserEl) hueUserEl.value = config.hueUser;
            }
            if (config.hueLights !== undefined && Array.isArray(config.hueLights)) {
                const hueLightsEl = document.getElementById('config-hue-lights');
                if (hueLightsEl) hueLightsEl.value = config.hueLights.join(', ');
            }

            // Update local state
            soundVolume = (config.volume || 70) / 100;
            soundEnabled = config.soundEnabled !== false;
        });

        // Request initial config?
        // dashboardWindow.webContents.send('settings:load', config) call in main.js creation would be better.
        // For now, we rely on local state or defaults.


        // ‚ïê‚ïê‚ïê FEED HELPERS ‚ïê‚ïê‚ïê
        function addFeedItem(feedId, icon, text) {
            const feed = document.getElementById(feedId);
            const time = new Date().toLocaleTimeString([], { hour12: false });
            const item = document.createElement('div');
            item.className = 'feed-item';
            item.innerHTML = `
                <span class="feed-time">${time}</span>
                <span class="feed-icon">${icon}</span>
                <span class="feed-text">${text}</span>
            `;
            feed.prepend(item);
            if (feed.children.length > 150) feed.lastElementChild.remove();
            return item;
        }

        function addDashItem(icon, text) { return addFeedItem('event-feed', icon, text); }
        function addVconItem(icon, text) { addFeedItem('vcon-feed', icon, text); }

        // ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
        function openLogin() {
            console.log('[Dashboard] openLogin clicked!');
            // v2.2 - Use custom protocol redirect
            ipcRenderer.invoke('app:open-external', 'https://versecon.space/api/auth/discord/login?redirect=versecon-link://auth').then(() => {
                addDashItem('üîë', 'Opening browser... Please login.');
            }).catch(err => {
                addDashItem('‚ùå', 'Failed to open browser: ' + err.message);
            });
        }

        function loginManual() {
            const token = document.getElementById('api-token-manual').value;
            if (token) {
                ipcRenderer.send('app:login', token);
                document.getElementById('auth-ui-guest').style.display = 'none';
                document.getElementById('auth-ui-user').style.display = 'block';
                addDashItem('üîí', 'Manual token set.');
            }
        }

        function confirmClearDb() {
            if (confirm("Are you sure you want to permanently delete all logs from the database?\nThis action cannot be undone.")) {
                ipcRenderer.send('logdb:clear');
            }
        }

        // ‚ïê‚ïê‚ïê NEW LOCATION TOAST LOGIC ‚ïê‚ïê‚ïê
        function showNewLocationToast(displayName, rawName) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed; bottom:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; pointer-events:none;';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.style.cssText = `
                background: rgba(11, 12, 16, 0.95);
                border: 1px solid var(--accent);
                border-left: 4px solid var(--accent);
                border-radius: 6px;
                padding: 12px 16px;
                color: white;
                box-shadow: 0 4px 15px rgba(0,0,0,0.5), 0 0 10px rgba(255,165,0,0.2);
                backdrop-filter: blur(10px);
                font-family: 'Rajdhani', sans-serif;
                min-width: 280px;
                animation: slideIn 0.3s ease forwards;
                pointer-events: auto;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
            `;

            toast.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                    <div style="font-weight:700; color:var(--accent); font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">üìç New Location Detected</div>
                    <button onclick="event.stopPropagation(); this.parentElement.parentElement.remove()" style="background:none; border:none; color:#888; cursor:pointer; font-size:1.2rem; padding:0; line-height:1;">&times;</button>
                </div>
                <div style="font-size:0.95rem; margin-bottom:6px;">${escapeHtml(displayName)}</div>
                <div style="font-size:0.75rem; color:var(--text-dim);">Click to map a custom name</div>
            `;

            toast.onmouseenter = () => {
                toast.style.transform = 'translateY(-2px)';
                toast.style.boxShadow = '0 6px 20px rgba(0,0,0,0.6), 0 0 15px rgba(255,165,0,0.4)';
            };
            toast.onmouseleave = () => {
                toast.style.transform = 'translateY(0)';
                toast.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5), 0 0 10px rgba(255,165,0,0.2)';
            };

            toast.onclick = () => {
                // Switch to Settings Tab
                switchTab('config');

                // Populate the Custom Locations form
                const keyInput = document.getElementById('new-loc-key');
                const valInput = document.getElementById('new-loc-val');

                if (keyInput && valInput) {
                    keyInput.value = rawName || displayName;
                    valInput.value = '';
                    valInput.focus();

                    // Highlight the form briefly
                    const formContainer = keyInput.closest('div[style*="background: rgba(0,0,0,0.3)"]'); // This selector might need adjustment based on actual HTML structure
                    if (formContainer) {
                        const originalBg = formContainer.style.background;
                        formContainer.style.background = 'rgba(255, 165, 0, 0.2)';
                        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => formContainer.style.background = originalBg, 1000);
                    }
                }
                toast.remove();
            };

            container.appendChild(toast);

            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(20px)';
                    toast.style.transition = 'opacity 0.3s, transform 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 10000);
        }

        function toggleOverlay() { ipcRenderer.send('app:toggle-overlay'); }

        function selectLogFile() {
            ipcRenderer.invoke('app:select-log').then(path => {
                if (path) {
                    document.getElementById('config-log-path').value = path;
                    addDashItem('‚öôÔ∏è', `Log path set: ${path}`);
                }
            });
        }

        // ‚ïê‚ïê‚ïê COMMAND MODULE ‚ïê‚ïê‚ïê
        function sendPresetCommand(preset) {
            const target = document.getElementById('cmd-target').value;
            const data = {
                preset,
                target,
                fromTeam: config.userTeam || 'Alpha',
                timestamp: Date.now()
            };
            ipcRenderer.send('command:send', data);
            addCommandLog(preset, target, 'YOU');
            playSound(preset === 'EMERGENCY' ? 'sos' : 'command');
        }

        function sendCustomCommand() {
            const text = document.getElementById('cmd-custom-text').value.trim();
            if (!text) return;
            const target = document.getElementById('cmd-target').value;
            const broadcast = document.getElementById('cmd-broadcast').checked;
            const data = {
                text,
                target,
                fromTeam: config.userTeam || 'Alpha',
                broadcast,
                timestamp: Date.now()
            };
            ipcRenderer.send('command:send', data);
            addCommandLog(text, target, 'YOU');
            document.getElementById('cmd-custom-text').value = '';
            playSound('command');
        }

        function addCommandLog(text, target, from) {
            const log = document.getElementById('command-log');
            // Remove placeholder
            const placeholder = log.querySelector('div[style]');
            if (placeholder && placeholder.textContent.includes('No commands')) placeholder.remove();

            const time = new Date().toLocaleTimeString([], { hour12: false });
            const item = document.createElement('div');
            item.className = 'cmd-log-item';
            item.innerHTML = `
                <div class="cmd-log-from">${time} ‚Äî FROM: ${from}</div>
                <div class="cmd-log-text">${text}</div>
                <div class="cmd-log-target">‚Üí ${target}</div>
                <div class="cmd-log-ack" id="ack-${Date.now()}">‚è≥ Awaiting ACK...</div>
            `;
            log.prepend(item);
        }

        // ‚ïê‚ïê‚ïê SHIP IMAGE MANAGER (v2.2) ‚ïê‚ïê‚ïê
        let shipMap = {};

        function loadShipMap() {
            ipcRenderer.invoke('settings:get-ship-map').then(map => {
                shipMap = map || {};
                renderShipMapList();
            });
        }

        function renderShipMapList() {
            const list = document.getElementById('ship-map-list');
            if (Object.keys(shipMap).length === 0) {
                list.innerHTML = '<div style="padding: 10px; font-style: italic; color: #555; text-align: center;">No mappings set.</div>';
                return;
            }
            list.innerHTML = Object.entries(shipMap).map(([name, path]) => `
                <div class="map-item" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="flex: 1;">
                        <span style="color: var(--accent); font-weight: bold;">${name}</span>
                        <div style="font-size: 0.7rem; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">${path}</div>
                    </div>
                    <button class="cyber-btn small danger" onclick="removeShipMapping('${name}')" style="margin:0; padding: 2px 8px;">√ó</button>
                </div>
            `).join('');
        }

        function selectNewShipImage() {
            ipcRenderer.invoke('app:select-ship-image').then(path => {
                if (path) {
                    document.getElementById('new-ship-image-path').value = path;
                    document.getElementById('new-ship-filename').textContent = path.split(/[\\\\/]/).pop();
                    document.getElementById('new-ship-preview-label').style.display = 'block';
                }
            });
        }

        function addShipMapping() {
            const name = document.getElementById('new-ship-name').value.trim();
            const path = document.getElementById('new-ship-image-path').value;

            if (!name) return alert('Please enter a ship name.');
            if (!path) return alert('Please select an image.');

            shipMap[name] = path;
            saveShipMap();

            // Clear inputs
            document.getElementById('new-ship-name').value = '';
            document.getElementById('new-ship-image-path').value = '';
            document.getElementById('new-ship-preview-label').style.display = 'none';
            renderShipMapList();
        }

        function removeShipMapping(name) {
            delete shipMap[name];
            saveShipMap();
            renderShipMapList();
        }

        function saveShipMap() {
            ipcRenderer.invoke('settings:save-ship-map', shipMap);
        }

        // ‚ïê‚ïê‚ïê DETECTED SHIP HELPER ‚ïê‚ïê‚ïê
        let lastDetectedShip = null;
        ipcRenderer.on('settings:last-ship', (e, shipName) => {
            if (!shipName) return;
            lastDetectedShip = shipName;
            const label = document.getElementById('detected-ship-label');
            if (label) {
                label.innerHTML = `Detected: <strong style="color:var(--accent)">${shipName}</strong> <a href="#" onclick="useDetectedShip('${shipName}')" style="font-size:0.8em; margin-left:10px">[USE THIS]</a>`;
                label.style.display = 'block';
            }
        });

        window.useDetectedShip = (name) => {
            document.getElementById('new-ship-name').value = name;
        };

        // Mission Renaming
        window.renameCurrentMission = async () => {
            if (!window.currentMissionId) {
                // If no ID, try to rename current 'active' if main.js logic allows, or alert
                alert('No active Mission ID tracked. Accept a contract first.');
                return;
            }
            const currentName = document.getElementById('mission-title').innerText;
            const newName = await window.vcModal.prompt('Rename Mission', `Enter name for ID ${window.currentMissionId}:`, currentName);

            if (newName && newName !== currentName) {
                ipcRenderer.send('mission:rename', { id: window.currentMissionId, name: newName });
            }
        };

        // Initialize (called after ipcRenderer ready? No, call directly here, assuming early enough)
        loadShipMap();


        // ‚ïê‚ïê‚ïê MANUAL PATTERNS (v2.2) ‚ïê‚ïê‚ïê
        let customPatterns = [];

        function loadCustomPatterns() {
            ipcRenderer.invoke('settings:get-custom-patterns').then(patterns => {
                customPatterns = patterns || [];
                renderPatternList();
            });
        }

        function renderPatternList() {
            const list = document.getElementById('pattern-list');
            if (customPatterns.length === 0) {
                list.innerHTML = '<div style="padding: 10px; font-style: italic; color: #555; text-align: center;">No custom patterns defined.</div>';
                return;
            }
            list.innerHTML = customPatterns.map((p, i) => `
                <div class="map-item" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-family: monospace; color: var(--accent); font-size: 0.8rem;">${escapeHtml(p.regex)}</div>
                        <div style="font-size: 0.7rem; color: #888;">
                            <span style="font-weight:bold; color: ${getColorForLevel(p.level)}">${p.level}</span> ${escapeHtml(p.message)}
                            ${p.hueColor ? ` ‚Ä¢ <span style="color:#aa88ff;">HUE: ${p.hueColor.toUpperCase()}</span>` : ''}
                        </div>
                    </div>
                    <div>
                        <button class="cyber-btn small" onclick="editCustomPattern(${i})" style="margin:0 5px 0 0; padding: 2px 8px;">‚úèÔ∏è</button>
                        <button class="cyber-btn small danger" onclick="removeCustomPattern(${i})" style="margin:0; padding: 2px 8px;">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        function getColorForLevel(level) {
            switch (level) {
                case 'INFO': return '#4FC3F7';
                case 'WARN': return '#FFA726';
                case 'CRITICAL': return '#FF5252';
                default: return '#eee';
            }
        }

        let editingPatternIndex = -1;

        function addCustomPattern() {
            const regex = document.getElementById('new-pattern-regex').value.trim();
            const level = document.getElementById('new-pattern-level').value;
            const message = document.getElementById('new-pattern-msg').value.trim();
            const hueColor = document.getElementById('new-pattern-hue').value;

            if (!regex) return alert('Please enter a Regex pattern.');
            if (!message) return alert('Please enter an alert message.');

            // Validate Regex
            try {
                new RegExp(regex);
            } catch (e) {
                return alert('Invalid Regex: ' + e.message);
            }

            if (editingPatternIndex >= 0) {
                customPatterns[editingPatternIndex] = { regex, level, message, hueColor, id: customPatterns[editingPatternIndex].id || Date.now() };
                editingPatternIndex = -1;
                document.getElementById('btn-add-pattern').innerText = 'Add Pattern';
            } else {
                customPatterns.push({ regex, level, message, hueColor, id: Date.now() });
            }
            saveCustomPatterns();

            document.getElementById('new-pattern-regex').value = '';
            document.getElementById('new-pattern-msg').value = '';
            document.getElementById('new-pattern-hue').value = '';
            renderPatternList();
        }

        function editCustomPattern(index) {
            const pattern = customPatterns[index];
            document.getElementById('new-pattern-regex').value = pattern.regex;
            document.getElementById('new-pattern-level').value = pattern.level;
            document.getElementById('new-pattern-msg').value = pattern.message;
            document.getElementById('new-pattern-hue').value = pattern.hueColor || '';

            editingPatternIndex = index;
            document.getElementById('btn-add-pattern').innerText = 'Update Pattern';
            document.getElementById('new-pattern-regex').focus();
        }

        function removeCustomPattern(index) {
            customPatterns.splice(index, 1);
            if (editingPatternIndex === index) {
                editingPatternIndex = -1;
                document.getElementById('btn-add-pattern').innerText = 'Add Pattern';
                document.getElementById('new-pattern-regex').value = '';
                document.getElementById('new-pattern-msg').value = '';
                document.getElementById('new-pattern-hue').value = '';
            } else if (editingPatternIndex > index) {
                editingPatternIndex--;
            }
            saveCustomPatterns();
            renderPatternList();
        }

        function saveCustomPatterns() {
            ipcRenderer.invoke('settings:save-custom-patterns', customPatterns);
        }

        loadCustomPatterns();


        // ‚ïê‚ïê‚ïê UNKNOWN LOG DISCOVERY (Fixed: event delegation, full sample display) ‚ïê‚ïê‚ïê
        // Store groups data for event delegation
        let unknownGroupsData = [];

        function escapeHtml(str) {
            if (typeof str !== 'string') return String(str || '');
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ... existing codes ...

        function renderUnknowns(groups) {
            unknownGroupsData = groups;
            const list = document.getElementById('unknown-list');
            unknownCount = groups.length;
            document.getElementById('unknown-count-label').textContent = `(${unknownCount})`;

            // Update badge
            const badge = document.getElementById('unknown-badge');
            if (unknownCount > 0) {
                badge.style.display = 'inline';
                badge.textContent = unknownCount;
            } else {
                badge.style.display = 'none';
            }

            if (groups.length === 0) {
                list.innerHTML = '<div style="color: #555; font-style: italic; padding: 15px; text-align: center;">No unknown patterns detected yet.</div>';
                return;
            }

            list.innerHTML = groups.slice(0, 50).map((g, i) => `
                <div class="unknown-item">
                    <div class="unknown-header">
                        <span class="unknown-key">${escapeHtml(g.group)}</span>
                        <span class="unknown-count">${g.count}x</span>
                        <div class="unknown-actions">
                            <button class="btn-copy" data-idx="${i}" title="Copy full log line">üìã</button>
                            <button class="btn-ignore" data-idx="${i}" title="Ignore this pattern">üö´</button>
                        </div>
                    </div>
                    <div class="unknown-sample" title="${escapeHtml(g.sample)}">${escapeHtml(g.sample)}</div>
                </div>
            `).join('');
        }

        // Event delegation for unknown log buttons (fixes broken inline onclick)
        document.getElementById('unknown-list').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const idx = parseInt(btn.dataset.idx);
            if (isNaN(idx) || !unknownGroupsData[idx]) return;

            if (btn.classList.contains('btn-copy')) {
                navigator.clipboard.writeText(unknownGroupsData[idx].sample)
                    .then(() => addDashItem('üìã', 'Copied to clipboard'))
                    .catch(() => addDashItem('‚ùå', 'Copy failed'));
            } else if (btn.classList.contains('btn-ignore')) {
                ipcRenderer.send('log:ignore-unknown', unknownGroupsData[idx].group);
                addDashItem('üö´', `Ignored: ${unknownGroupsData[idx].group.substring(0, 40)}`);
            }
        });

        function refreshUnknowns() {
            ipcRenderer.send('log:request-unknowns');
        }

        function clearUnknowns() {
            ipcRenderer.send('log:clear-unknowns');
        }

        // ‚ïê‚ïê‚ïê COMMAND CENTER ‚ïê‚ïê‚ïê
        function sendPresetCommand(cmd) {
            const target = document.getElementById('cmd-target') ? document.getElementById('cmd-target').value : 'ALL';
            const broadcast = document.getElementById('cmd-broadcast') ? document.getElementById('cmd-broadcast').checked : false;

            // Log it locally
            addCommandLog(cmd, target);

            // Send to overlay if broadcast is checked
            if (broadcast) {
                ipcRenderer.send('command:send', { command: cmd, target: target });
            }

            // Also send to overlay for HUD display
            ipcRenderer.send('command:overlay', { command: cmd, target: target });
        }

        function sendCustomCommand() {
            const textInput = document.getElementById('cmd-custom-text');
            const cmd = textInput ? textInput.value.trim() : '';
            if (!cmd) return;

            const target = document.getElementById('cmd-target') ? document.getElementById('cmd-target').value : 'ALL';
            const broadcast = document.getElementById('cmd-broadcast') ? document.getElementById('cmd-broadcast').checked : false;

            addCommandLog(cmd, target);

            if (broadcast) {
                ipcRenderer.send('command:send', { command: cmd, target: target });
            }

            ipcRenderer.send('command:overlay', { command: cmd, target: target });
            textInput.value = '';
        }

        function addCommandLog(cmd, target) {
            const log = document.getElementById('command-log');
            const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            entry.className = 'feed-item';
            entry.innerHTML = `
                <span class="feed-time">${time}</span>
                <span class="feed-icon">üì°</span>
                <span><b style="color:var(--accent);">[${target}]</b> ${cmd}</span>
            `;
            log.prepend(entry);

            // Remove the placeholder text if it exists
            const placeholder = log.querySelector('[style*="italic"]');
            if (placeholder && placeholder.textContent.includes('No commands')) placeholder.remove();
        }

        // ‚ïê‚ïê‚ïê ALERT COOLDOWNS ‚ïê‚ïê‚ïê
        function updateCooldown(alertType, seconds) {
            document.getElementById(`cd-${alertType}-val`).textContent = `${seconds}s`;
            ipcRenderer.send('alert:set-cooldown', { alertType, cooldownMs: seconds * 1000 });
        }

        // Initialize cooldowns from defaults
        updateCooldown('suffocating', 5);
        updateCooldown('depressurizing', 5);

        // ‚ïê‚ïê‚ïê SHIP IMAGE ‚ïê‚ïê‚ïê
        function selectShipImage() {
            ipcRenderer.invoke('app:select-ship-image').then(path => {
                if (path) {
                    document.getElementById('ship-image-path').value = path;
                    document.getElementById('ship-preview').style.display = 'block';
                    document.getElementById('ship-preview-img').src = path;
                    // Broadcast to overlay
                    ipcRenderer.send('app:login', ''); // slight hack, we directly use broadcast
                    // Actually, send via main ‚Üí overlay
                    localStorage.setItem('shipImagePath', path);
                    addDashItem('üñºÔ∏è', `Ship image set: ${path.split(/[\\/]/).pop()}`);
                }
            });
        }

        function clearShipImage() {
            document.getElementById('ship-image-path').value = '';
            document.getElementById('ship-preview').style.display = 'none';
            localStorage.removeItem('shipImagePath');
            addDashItem('üñºÔ∏è', 'Ship image cleared');
        }

        // ‚ïê‚ïê‚ïê EVENT LISTENERS ‚ïê‚ïê‚ïê

        // Game log events
        ipcRenderer.on('log:status', (e, data) => {
            const dot = document.getElementById('status-log-dot');
            const txt = document.getElementById('status-log-text');
            if (data.connected) {
                dot.className = 'dot on';
                txt.innerText = 'Active';
                if (data.path) {
                    document.getElementById('config-log-path').value = data.path;
                    addDashItem('üìÇ', `Game.log: <span class="feed-highlight">${data.path}</span>`);
                }
            } else {
                dot.className = 'dot off';
                txt.innerText = data.message || 'Searching';
                if (data.message) {
                    addDashItem('‚ö†Ô∏è', `Log issue: ${data.message}`);
                }
            }
        });

        // FIX 3: Handle log errors from main process
        ipcRenderer.on('log:error', (e, data) => {
            if (data && data.message) {
                addDashItem('‚ùå', `Log Error: ${data.message}`);
            }
        });

        let lastGlobalLocation = '';
        let lastRawLocation = ''; // Added for Location Sniffing

        ipcRenderer.on('settings:friend-code', (e, code) => {
            document.getElementById('display-friend-code').textContent = code;
        });

        function copyFriendCode() {
            const code = document.getElementById('display-friend-code').textContent;
            navigator.clipboard.writeText(code);
            showNotification('üìã Friend Code Copied', 'Share it with your squadron!');
        }

        function addFriendByCode() {
            const input = document.getElementById('add-friend-code');
            const code = input.value.trim().toUpperCase();
            if (code.length !== 6) return alert('Invalid code. Must be 6 characters.');

            // Placeholder logic
            alert(`Sending friend request to ${code}...`);
            input.value = '';
        }

        function showNotification(title, body) {
            // Implementation of a small toast could go here, or use existing alerts
            console.log(`[Notification] ${title}: ${body}`);
        }

        ipcRenderer.on('log:update', (e, data) => {
            // Location Sniffing (v2.6)
            if (data.type === 'LOCATION' && data.raw) {
                lastRawLocation = data.raw;
                const sniffer = document.getElementById('last-raw-location');
                if (sniffer) sniffer.textContent = data.raw;
            } else if (data.type === 'LOCATION_RAW') {
                lastRawLocation = data.value;
                const sniffer = document.getElementById('last-raw-location');
                if (sniffer) sniffer.textContent = data.value;
            }

            // Raw Feed (Tail)
            addRawLogLine(data.raw || JSON.stringify(data)); // Fallback if no raw line

            switch (data.type) {
                case 'LOCATION':
                    lastGlobalLocation = data.value;
                    addDashItem('üìç', `Location: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'LOCATION_HINT':
                    const display = lastGlobalLocation ? `${lastGlobalLocation} ‚Äî ${data.value}` : data.value;
                    addDashItem('üó∫Ô∏è', `Area: <span class="feed-highlight">${display}</span>`);
                    break;
                case 'QUANTUM':
                    addDashItem('üöÄ', `Quantum: <span class="feed-highlight">${data.value === 'entered' ? 'ENGAGED' : 'DISENGAGED'}</span>`);
                    playSound('alert_zone');
                    break;
                case 'ZONE':
                    if (data.value === 'Armistice Zone') { addDashItem('üõ°Ô∏è', 'Entered <span class="feed-highlight">Armistice Zone</span>'); }
                    else if (data.value === 'Open Space') { addDashItem('‚ö†Ô∏è', '<span class="feed-highlight" style="color:#ffaa00">LEFT ARMISTICE</span> ‚Äî Weapons Hot'); playSound('alert_zone'); }
                    break;
                case 'STATUS':
                    if (data.value === 'suffocating') { addDashItem('üòµ', '<span class="feed-highlight" style="color:#ff4444">SUFFOCATING</span>'); playSound('alert_status'); }
                    else if (data.value === 'depressurizing') { addDashItem('üí®', '<span class="feed-highlight" style="color:#ff4444">DEPRESSURIZATION</span>'); playSound('alert_status'); }
                    else if (data.value === 'death') { addDashItem('üíÄ', '<span class="feed-highlight" style="color:#ff4444">DEATH DETECTED</span>'); playSound('alert_death'); }
                    break;
                case 'DEATH': {
                    const d = data.details || {};
                    const victim = d.victim || 'Unknown';
                    const killer = d.killer && d.killer !== 'Unknown' ? ` by ${d.killer}` : '';
                    addDashItem('üíÄ', `<span class="feed-highlight" style="color:#ff4444">${victim} KILLED${killer}</span>`);
                    playSound('alert_death');
                    break;
                }
                case 'LOGIN':
                    addDashItem('üëã', `Session: <span class="feed-highlight">${data.handle || 'Login Detected'}</span>`);
                    break;
                case 'PLAYER_NAME':
                    addDashItem('üéÆ', `Pilot: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'CHARACTER_NAME':
                    addDashItem('üë§', `Character: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'CONNECTION':
                    addDashItem('üîó', `Connection: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'LOADING':
                    addDashItem('‚è≥', 'Loading screen...');
                    break;
                // ‚ïê‚ïê‚ïê NEW: Server & Environment ‚ïê‚ïê‚ïê
                case 'SERVER_ENV':
                    addDashItem('üåç', `Server: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'SERVER_REGION':
                    addDashItem('üåê', `Region: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'SERVER_CONNECTED':
                    if (data.value && data.value.shard) {
                        addDashItem('üåê', `Shard: <span class="feed-highlight" style="color:#00c8ff">${data.value.shard}</span>`);
                    }
                    break;
                case 'JURISDICTION':
                    addDashItem('üèõÔ∏è', `<span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'SESSION_ID':
                    addDashItem('üîë', `Session: <span class="feed-highlight" style="font-size:0.7rem">${data.value.substring(0, 12)}...</span>`);
                    break;
                // ‚ïê‚ïê‚ïê NEW: Ship Events ‚ïê‚ïê‚ïê
                case 'SHIP_ENTER':
                    addDashItem('üöÄ', `Boarded: <span class="feed-highlight" style="color:#00c8ff">${data.value}</span>`);
                    document.getElementById('last-ship-debug').textContent = data.value; // Update Settings UI
                    playSound('notification');
                    break;
                case 'SHIP_EXIT':
                    addDashItem('üö∂', `Exited ship: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'SHIP_CURRENT':
                    addDashItem('üöÄ', `Current ship: <span class="feed-highlight" style="color:#00c8ff">${data.value}</span>`);
                    break;
                case 'VEHICLE_SPAWN':
                    addDashItem('üõ∏', `Vehicle spawned: <span class="feed-highlight">${data.value}</span>`);
                    break;
                // ‚ïê‚ïê‚ïê NEW: Game Join/Leave ‚ïê‚ïê‚ïê
                case 'GAME_JOIN':
                    addDashItem('üü¢', `<span class="feed-highlight" style="color:var(--success)">ENTERED THE VERSE</span>`);
                    break;
                case 'GAME_LEAVE':
                    addDashItem('üî¥', `<span class="feed-highlight" style="color:var(--danger)">LEFT THE VERSE</span>`);
                    break;
                // ‚ïê‚ïê‚ïê NEW: Unmapped Location Toast ‚ïê‚ïê‚ïê
                case 'NEW_LOCATION':
                    showNewLocationToast(data.value || data.raw, data.raw);
                    break;
                    addDashItem('üéÆ', '<span class="feed-highlight" style="color:#00ff88">CONNECTED TO SERVER</span>');
                    playSound('notification');
                    break;
                case 'GAME_LEAVE':
                    addDashItem('üö™', '<span class="feed-highlight" style="color:#ffaa00">DISCONNECTED</span>');
                    playSound('alert_status');
                    break;
                case 'GAME_RESTART':
                    addDashItem('üîÑ', '<span class="feed-highlight">Game restarting...</span>');
                    break;
                // ‚ïê‚ïê‚ïê NEW: Multi-Mission List ‚ïê‚ïê‚ïê
                case 'MISSION_ACCEPTED':
                case 'MISSION_OBJECTIVE':
                case 'MISSION_STATUS':
                case 'MISSION_CHANGED':
                    // These are handled via 'mission:list' broadcast usually, but if we get individual events we can ignore or log.
                    // Main.js sends 'mission:list' after these.
                    break;

                // ‚ïê‚ïê‚ïê NEW: Insurance ‚ïê‚ïê‚ïê
                case 'INSURANCE_CLAIM':
                    addDashItem('üõ°Ô∏è', `<span class="feed-highlight" style="color:#a855f7">INSURANCE CLAIM</span>`);
                    playSound('alert_status');
                    break;
                // ‚ïê‚ïê‚ïê Fire & Combat ‚ïê‚ïê‚ïê
                case 'HAZARD_FIRE':
                    addDashItem('üî•', `<span class="feed-highlight" style="color:#ff2222">FIRE ONBOARD</span> ${data.room ? `(${data.room})` : ''}`);
                    playSound('alert_death');
                    break;
                case 'VEHICLE_DESTRUCTION':
                    addDashItem('üí•', `<span class="feed-highlight" style="color:#ff4444">VEHICLE DESTROYED</span> ${data.value || ''}`);
                    playSound('alert_death');
                    break;
                case 'KILL_PLAYER':
                    addDashItem('‚ò†Ô∏è', `<span class="feed-highlight" style="color:#ff4444">${data.value || 'Player Kill'}</span>`);
                    playSound('alert_status');
                    break;
                case 'KILL_NPC':
                    addDashItem('üéØ', `NPC Kill: <span class="feed-highlight">${data.value || 'Target Down'}</span>`);
                    break;
                case 'CRIMESTAT':
                    addDashItem('üö®', `<span class="feed-highlight" style="color:#ff6600">CRIMESTAT ${data.value || ''}</span>`);
                    playSound('alert_status');
                    break;
                // ‚ïê‚ïê‚ïê NEW: Docking ‚ïê‚ïê‚ïê
                case 'DOCKING':
                    addDashItem('üîó', `Docking <span class="feed-highlight">${data.value}</span>`);
                    playSound('notification');
                    break;
                // ‚ïê‚ïê‚ïê NEW: Inventory (Stacked) ‚ïê‚ïê‚ïê
                case 'INVENTORY': {
                    // Stack rapid inventory updates into a single counter
                    const feed = document.getElementById('event-feed');
                    const lastEntry = feed && feed.firstElementChild;
                    if (lastEntry && lastEntry.dataset.type === 'INVENTORY') {
                        const count = parseInt(lastEntry.dataset.count || '1') + 1;
                        lastEntry.dataset.count = count;
                        lastEntry.querySelector('.feed-text').innerHTML = `Inventory Updated <span class="feed-highlight">(√ó${count})</span>`;
                    } else {
                        const item = addDashItem('üì¶', `Inventory <span class="feed-highlight">${data.value}</span>`);
                        if (item) { item.dataset.type = 'INVENTORY'; item.dataset.count = '1'; }
                    }
                    break;
                }
                // ‚ïê‚ïê‚ïê NEW: Medical & Spawn ‚ïê‚ïê‚ïê
                case 'MEDICAL_BED':
                    addDashItem('üè•', '<span class="feed-highlight" style="color:#00c8ff">Medical Bed</span>');
                    break;
                case 'SPAWN_SET':
                case 'SPAWN_POINT':
                    addDashItem('üìç', `Spawn: <span class="feed-highlight">${data.value}</span>`);
                    break;

                // ‚ïê‚ïê‚ïê PHASE 2: INDUSTRIAL ‚ïê‚ïê‚ïê
                case 'MINING':
                    if (data.subtype === 'LASER') {
                        const color = data.state === 'ON' ? '#00ff88' : '#888';
                        addDashItem('‚õèÔ∏è', `Mining Laser: <span class="feed-highlight" style="color:${color}">${data.state}</span>`);
                    } else if (data.subtype === 'FRACTURE') {
                        const color = data.success ? '#00ff88' : '#ff4444';
                        const text = data.success ? 'SUCCESS' : 'FAILED';
                        addDashItem('üí•', `Fracture: <span class="feed-highlight" style="color:${color}">${text}</span>`);
                        if (data.success) playSound('notification');
                    } else if (data.subtype === 'EXTRACTION') {
                        addDashItem('üíé', `Extracted: <span class="feed-highlight" style="color:#ffa500">${data.amount.toFixed(2)} SCU</span> ${data.material}`);
                    }
                    break;

                case 'SALVAGE':
                    if (data.subtype === 'BEAM') {
                        const color = data.state === 'ON' ? '#00ff88' : '#888';
                        addDashItem('üèóÔ∏è', `Salvage Beam: <span class="feed-highlight" style="color:${color}">${data.state}</span>`);
                    } else if (data.subtype === 'SCRAPE') {
                        addDashItem('‚ôªÔ∏è', `Scraped: <span class="feed-highlight" style="color:#00c8ff">${data.amount.toFixed(2)} SCU</span> ${data.material}`);
                    }
                    break;

                case 'ENGINEERING':
                    if (data.subtype === 'POWER') {
                        addDashItem('‚ö°', `Power Plant: <span class="feed-highlight">${data.state}</span>`);
                    } else if (data.subtype === 'FUSE_BREAK') {
                        addDashItem('üîå', `Fuse Blown: <span class="feed-highlight" style="color:#ff4444">${data.component}</span> in ${data.room}`);
                        playSound('alert_status');
                    }
                    break;

                // MISSION TRACKING
                case 'MISSION_CURRENT':
                    document.getElementById('mission-status-box').style.display = 'block';
                    document.getElementById('mission-title').innerText = data.value;
                    document.getElementById('mission-title').title = data.value; // Tooltip for overflow
                    addDashItem('üìú', `Mission Accepted: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'MISSION_OBJECTIVE':
                    document.getElementById('mission-status-box').style.display = 'block';
                    document.getElementById('mission-objective').innerText = data.value;
                    addDashItem('üéØ', `Objective: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'MISSION_CLEARED':
                    document.getElementById('mission-title').innerText = 'Completed / Ended';
                    document.getElementById('mission-objective').innerText = '-';
                    setTimeout(() => {
                        // Only hide if it hasn't been updated again
                        if (document.getElementById('mission-title').innerText.includes('Completed')) {
                            document.getElementById('mission-status-box').style.display = 'none';
                        }
                    }, 10000); // Keep result visible for 10s
                    addDashItem('‚úÖ', 'Mission Ended');
                    break;

                // ‚ïê‚ïê‚ïê NEW: Party ‚ïê‚ïê‚ïê
                case 'PARTY_INVITE':
                    addDashItem('üì©', '<span class="feed-highlight" style="color:#ffa500">Party invite pending</span>');
                    playSound('notification');
                    break;
                case 'ACCOUNT_LOGIN':
                    addDashItem('‚úÖ', '<span class="feed-highlight" style="color:#00ff88">Account Login Success</span>');
                    break;
                // System info
                case 'SYSTEM_GPU':
                    addDashItem('üñ•Ô∏è', `GPU: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'SYSTEM_VRAM':
                    addDashItem('üñ•Ô∏è', `VRAM: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'SYSTEM_CPU':
                    addDashItem('üñ•Ô∏è', `CPU: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'SYSTEM_RAM':
                    addDashItem('üñ•Ô∏è', `RAM: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'GAME_VERSION':
                    addDashItem('üì¶', `SC Branch: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'RESOLUTION':
                    addDashItem('üñ•Ô∏è', `Display: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'JOYSTICK':
                    addDashItem('üïπÔ∏è', `Controller: <span class="feed-highlight">${data.value}</span>`);
                    break;
                case 'EQUIPMENT':
                    addDashItem('üéí', `Loadout: <span class="feed-highlight">${data.value.item}</span> ‚Üí ${data.value.port}`);
                    break;
            }
        });

        ipcRenderer.on('log:error', (e, data) => {
            addDashItem('‚ùå', `<span style="color:#ff4444">${data.message}</span>`);
            document.getElementById('status-log-dot').className = 'dot off';
            document.getElementById('status-log-text').innerText = 'Error';
        });

        // Unknown log events
        ipcRenderer.on('log:unknown', (e, data) => {
            renderUnknowns(data.groups || []);
        });

        // API connection
        ipcRenderer.on('api:status', (e, status) => {
            const dot = document.getElementById('status-api-dot');
            const txt = document.getElementById('status-api-text');
            if (status.connected) {
                dot.className = 'dot on'; txt.innerText = 'Secure';
                addDashItem('‚úÖ', 'VerseCon API Connected');
            } else {
                dot.className = 'dot off'; txt.innerText = 'Disconnected';
            }
        });

        // Party data
        ipcRenderer.on('api:party', (e, data) => {
            addDashItem('üë•', `Party: <span class="feed-highlight">${data.members ? data.members.length : 0} Members</span>`);
        });

        // VerseCon platform events
        ipcRenderer.on('vcon:beacon', (e, data) => {
            addVconItem('üÜò', `<span class="feed-highlight" style="color:#FF2E63">BEACON</span> ‚Äî ${data.message || 'Distress signal!'}`);
            playSound('beacon');
        });

        ipcRenderer.on('vcon:job', (e, data) => {
            addVconItem('üìú', `<span class="feed-highlight">CONTRACT</span> ‚Äî ${data.message || 'New contract posted'}`);
            playSound('contract');
        });

        ipcRenderer.on('vcon:party_event', (e, data) => {
            const icon = data.type === 'LFG' ? 'üéÆ' : 'üéØ';
            const label = data.type === 'LFG' ? 'LFG' : 'OPERATION';
            addVconItem(icon, `<span class="feed-highlight">${label}</span> ‚Äî ${data.message || 'New event'}`);
            playSound('notification');
        });

        // v2.2 - Platform Notifications (Toasts & Feed)
        ipcRenderer.on('vcon:notification', (e, data) => {
            // data = { title, message, type: 'info|success|warning|error' }
            const iconMap = { info: '‚ÑπÔ∏è', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };
            const icon = iconMap[data.type] || 'üîî';
            addVconItem(icon, `<span class="feed-highlight">${data.title}</span> ‚Äî ${data.message}`);
            playSound('notification');
        });

        // Command events
        ipcRenderer.on('command:receive', (e, data) => {
            addCommandLog(data.preset || data.text, data.target || 'YOU', data.from || 'COMMAND');
            playSound(data.preset === 'EMERGENCY' ? 'sos' : 'command');
            // Also show in dashboard feed
            addDashItem('üì¢', `<span class="feed-highlight" style="color:#ffa500">ORDER: ${data.preset || data.text}</span> from ${data.from || 'Command'}`);
        });

        ipcRenderer.on('command:sent', (e, data) => {
            // Visual confirmation
        });

        // Auth deep link
        ipcRenderer.on('auth:success', (e, token) => {
            document.getElementById('auth-ui-guest').style.display = 'none';
            document.getElementById('auth-ui-user').style.display = 'block';
            addDashItem('‚úÖ', 'Authenticated via Browser!');
        });

        // DND toggle
        ipcRenderer.on('app:dnd', (e, data) => {
            addDashItem('üîï', data.enabled ? 'Do Not Disturb: ON' : 'Do Not Disturb: OFF');
        });

        // TTS Reaction (v2.8)
        ipcRenderer.on('app:tts', (e, text) => {
            if (dndMode) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            window.speechSynthesis.speak(utterance);
        });

        // Keyboard shortcut for sending commands
        document.getElementById('cmd-custom-text').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendCustomCommand();
        });
        // v2.2 - Last Detected Ship Debugging
        ipcRenderer.on('settings:last-ship', (e, shipName) => {
            document.getElementById('last-ship-debug').textContent = shipName || 'None';
            document.getElementById('last-ship-debug').style.color = '#fff';
        });
        // ‚ïê‚ïê‚ïê CUSTOM LOCATIONS (Fixed) ‚ïê‚ïê‚ïê
        let customLocations = {};

        function loadCustomLocationList() {
            ipcRenderer.invoke('settings:get-custom-locations').then(locs => {
                customLocations = locs || {};
                renderCustomLocationList();
            });
        }

        function renderCustomLocationList() {
            const list = document.getElementById('custom-location-list');
            if (!list) return;

            if (Object.keys(customLocations).length === 0) {
                list.innerHTML = '<div style="font-style:italic; color:#555; text-align:center; padding:10px;">No custom locations saved.</div>';
                return;
            }

            list.innerHTML = Object.entries(customLocations).map(([key, val]) => {
                const name = typeof val === 'object' ? val.name : val;
                const zone = typeof val === 'object' ? val.zone : 'Auto';
                const zoneBadge = zone !== 'Auto' ? `<span style="background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:3px; font-size:0.6rem; margin-left:5px; color:#aaa;">${zone}</span>` : '';

                return `
                        <div class="map-item" style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; border-radius:4px; transition:background 0.2s; background:rgba(0,0,0,0.1);" onmouseenter="this.style.background='rgba(255,165,0,0.1)'" onmouseleave="this.style.background='rgba(0,0,0,0.1)'">
                            <div style="overflow:hidden; flex:1;">
                                <div style="font-family:monospace; color:var(--accent); font-size:0.8rem; font-weight:600;">${escapeHtml(key)}</div>
                                <div style="color:#00ff88; font-size:0.75rem; margin-top:2px;">‚ûî ${escapeHtml(name)}${zoneBadge}</div>
                            </div>
                            <button class="cyber-btn small" onclick="event.stopPropagation(); openLocationSearch(); selectLocationForEdit('${encodeURIComponent(key)}')" style="margin-left:10px; margin:0 0 0 8px;">‚úèÔ∏è</button>
                            <button class="cyber-btn small danger" onclick="deleteCustomLocation('${key}')" style="margin-left:5px; margin:0;">√ó</button>
                        </div>
                    `;
            }).join('');
        }

        // let lastRawLocation = ''; (Already declared above)

        function grabRawLocation() {
            if (!lastRawLocation) return;
            document.getElementById('new-loc-key').value = lastRawLocation;
            // Focus friendly name input for convenience
            document.getElementById('new-loc-val').focus();
        }

        // ‚ïê‚ïê‚ïê BUILT-IN PATTERN MANAGER (v2.2) ‚ïê‚ïê‚ïê
        let defaultPatterns = {};
        let patternOverrides = {};

        async function loadBuiltinPatterns() {
            try {
                defaultPatterns = await ipcRenderer.invoke('settings:get-default-patterns');
                patternOverrides = await ipcRenderer.invoke('settings:get-pattern-overrides');
                renderBuiltinPatterns();
            } catch (e) {
                console.error('Failed to load patterns:', e);
            }
        }

        function renderBuiltinPatterns() {
            const list = document.getElementById('builtin-pattern-list');
            if (!list) return;
            list.innerHTML = '';

            const keys = Object.keys(defaultPatterns).sort();

            keys.forEach(key => {
                const config = patternOverrides[key] || {};
                const isDisabled = config.disabled;
                const currentRegex = config.regex || defaultPatterns[key];
                const defaultRegex = defaultPatterns[key];
                const customMsg = config.message || '';

                const item = document.createElement('div');
                item.className = 'map-item';
                item.style.cssText = 'padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);';
                item.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; align-items: flex-start;">
                                <div>
                                    <span style="color: var(--accent); font-weight: bold; font-family: monospace; font-size: 0.9rem;">${key}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label style="font-size: 0.8rem; cursor: pointer;">
                                        <input type="checkbox" ${isDisabled ? '' : 'checked'} onchange="togglePattern('${key}', this.checked)"> Enabled
                                    </label>
                                    <button class="cyber-btn small danger" onclick="deleteBuiltinPattern('${key}')" title="Delete Pattern">√ó</button>
                                </div>
                            </div>
                            <div style="font-size: 0.7rem; color: #888; margin-bottom: 2px;">Trigger Regex:</div>
                            <div style="font-family:monospace; font-size:0.7rem; color:#666; margin-bottom:2px;">Default: ${escapeHtml(defaultRegex.toString())}</div>
                            <input type="text" class="modern-input" style="width: 100%; font-family: monospace; font-size: 0.8rem; margin-bottom: 8px; color: #aaffaa;"
                                value="${escapeHtml(currentRegex.toString())}" 
                                onchange="updatePatternRegex('${key}', this.value)"
                                ${isDisabled ? 'disabled' : ''}
                                placeholder="Regex Pattern">
                            <div style="font-size: 0.7rem; color: #888; margin-bottom: 2px;">Alert Message (Override):</div>
                            <input type="text" class="modern-input" style="width: 100%; font-size: 0.8rem;"
                                value="${escapeHtml(customMsg)}"
                                onchange="updatePatternMessage('${key}', this.value)"
                                ${isDisabled ? 'disabled' : ''}
                                placeholder="Leave empty to use system default...">
                        `;
                list.appendChild(item);
            });
        }

        function renderBuiltinList() {
            // Backwards compatibility for older calls
            renderBuiltinPatterns();
        }

        async function deleteBuiltinPattern(key) {
            if (await vcModal.confirm('Delete Pattern?', `Are you sure you want to delete the built-in pattern "${key}"?`)) {
                patternOverrides[key] = patternOverrides[key] || {};
                patternOverrides[key].deleted = true;
                await ipcRenderer.invoke('settings:save-pattern-overrides', patternOverrides);
                await loadBuiltinPatterns();
            }
        }

        function updatePatternValueMap(key, value) {
            if (!patternOverrides[key]) patternOverrides[key] = {};
            patternOverrides[key].valueMap = value;
            savePatternOverrides();
        }

        function togglePattern(key, enabled) {
            if (!patternOverrides[key]) patternOverrides[key] = {};
            patternOverrides[key].disabled = !enabled;
            // If re-enabling and no other overrides, maybe clean up?
            // For now just save state.
            savePatternOverrides();
            renderBuiltinList();
        }

        function updatePatternRegex(key, value) {
            if (!patternOverrides[key]) patternOverrides[key] = {};
            patternOverrides[key].regex = value;
            // If value matches default, strictly we could remove it, but explicit override is safer for user intent
            savePatternOverrides();
        }

        function updatePatternMessage(key, value) {
            if (!patternOverrides[key]) patternOverrides[key] = {};
            patternOverrides[key].message = value;
            savePatternOverrides();
        }

        async function savePatternOverrides() {
            await ipcRenderer.invoke('settings:save-pattern-overrides', patternOverrides);
            const btn = document.activeElement;
            if (btn && btn.tagName === 'BUTTON') {
                const originalText = btn.innerText;
                btn.innerText = 'Saved!';
                setTimeout(() => btn.innerText = originalText, 2000);
            }
        }

        async function resetPatternOverrides() {
            if (confirm('Reset all built-in patterns to default?')) {
                patternOverrides = {};
                await ipcRenderer.invoke('settings:save-pattern-overrides', patternOverrides);
                renderBuiltinPatterns();
            }
        }

        // Raw log stream (v2.6 Batching)
        ipcRenderer.on('log:raw-batch', (e, batch) => {
            if (!Array.isArray(batch)) return;
            batch.forEach(line => addRawLogLine(line));
        });

        // Legacy support if needed
        ipcRenderer.on('log:raw', (e, line) => addRawLogLine(line));

        function addRawLogLine(line) {
            updateRecentLocations(line); // Pass to Settings Sniffer

            const rawFeed = document.getElementById('raw-log-list');
            if (!rawFeed) return;

            const div = document.createElement('div');
            div.className = 'log-line';
            div.style.cssText = 'border-bottom: 1px solid rgba(255,255,255,0.06); padding: 5px 4px; white-space: pre-wrap; word-break: break-all; cursor: pointer; transition: background 0.2s; border-radius: 2px;';
            div.title = 'Click to copy & use in Custom Locations';
            div.textContent = line;

            div.onclick = () => {
                navigator.clipboard.writeText(line);
                div.style.background = 'rgba(255,165,0,0.2)';
                setTimeout(() => div.style.background = 'transparent', 200);

                const locInput = document.getElementById('new-loc-key');
                if (locInput) {
                    let match = line.match(/RoomName:\s*([^\s]+)/) || line.match(/Location\[([^\]]+)\]/);
                    if (match) {
                        locInput.value = match[1];
                        document.getElementById('new-loc-val').focus();
                        alert('Code copied to Custom Location input: ' + match[1]);
                    } else {
                        if (!locInput.value) locInput.value = line;
                        addDashItem('üìã', 'Log line copied to clipboard');
                    }
                }
            };

            const filterInput = document.getElementById('raw-log-filter');
            const filterText = filterInput && filterInput.value ? filterInput.value.toLowerCase() : '';
            if (filterText && typeof line === 'string' && !line.toLowerCase().includes(filterText)) {
                div.style.display = 'none';
            }

            const isAtBottom = rawFeed.scrollHeight - rawFeed.clientHeight <= rawFeed.scrollTop + 50;
            rawFeed.appendChild(div);
            if (rawFeed.children.length > 200) rawFeed.firstElementChild.remove();
            if (isAtBottom) rawFeed.scrollTop = rawFeed.scrollHeight;
        }

        function filterRawLogs() {
            const term = document.getElementById('raw-log-filter').value.toLowerCase();
            const rawFeed = document.getElementById('raw-log-list');
            if (rawFeed) {
                Array.from(rawFeed.children).forEach(child => {
                    if (child.classList.contains('log-line')) {
                        if (!term || child.textContent.toLowerCase().includes(term)) {
                            child.style.display = '';
                        } else {
                            child.style.display = 'none';
                        }
                    }
                });
            }
        }

        // ‚ïê‚ïê‚ïê NEW: Mission List Renderer ‚ïê‚ïê‚ïê
        ipcRenderer.on('mission:list', (e, missions) => {
            renderMissionList(missions);
        });

        function renderMissionList(missions) {
            const container = document.getElementById('mission-status-box');
            if (!missions || missions.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            // Sort: Tracked first, then new
            missions.sort((a, b) => (b.tracked ? 1 : 0) - (a.tracked ? 1 : 0) || b.timestamp - a.timestamp);

            container.innerHTML = missions.map(m => `
                <div class="mission-entry ${m.tracked ? 'tracked' : ''}" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px">
                        <div style="font-size:0.7rem; color:${m.tracked ? 'var(--accent)' : '#888'}; font-weight:700; letter-spacing:1px">
                            ${m.tracked ? 'ACTIVE CONTRACT' : 'CONTRACT'}
                             <!-- ID for renaming context -->
                             ${m.tracked ? `<span onclick="window.currentMissionId='${m.id}'; renameCurrentMission()" style="cursor:pointer; margin-left:5px; opacity:0.7;" title="Rename Mission">‚úèÔ∏è</span>` : ''}
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="font-size:0.6rem; background:${m.tracked ? 'rgba(255,165,0,0.2)' : 'rgba(255,255,255,0.05)'}; 
                                        color:${m.tracked ? 'orange' : '#aaa'}; padding:1px 4px; border-radius:2px">
                                ${m.status === 'active' ? 'IN PROGRESS' : m.status.toUpperCase()}
                            </div>
                                    <span onclick="dismissMission('${m.id.replace(/'/g, "\\'")}')" style="cursor:pointer; color:#ff4444; font-size:0.8rem;" title="Dismiss / Remove" class="no-drag">‚ùå</span>
                                </div>
                    </div>
                    <div style="font-weight:600; color:${m.tracked ? 'white' : '#ccc'}; margin-bottom:4px; font-size: 0.85rem; line-height:1.2;">
                        ${escapeHtml(m.title)}
                    </div>
                    ${m.tracked ? `
                    <div style="font-size:0.65rem; color: #666; text-transform:uppercase; letter-spacing:0.5px">Objective</div>
                    <div style="font-size:0.75rem; color:#ddd; line-height:1.2;">${escapeHtml(m.objective)}</div>
                    ` : ''}
                </div>
            `).join('');

            // Allow renaming logic to work
            const tracked = missions.find(m => m.tracked);
            if (tracked) window.currentMissionId = tracked.id;
        }

        window.dismissMission = function (id) {
            // Encode/Escape not strictly needed if we pass ID cleanly, but IPC handles strings fine.
            ipcRenderer.send('mission:dismiss', id);
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SETTINGS: PATTERN GENERATOR (New)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function generatePattern() {
            const input = document.getElementById('pattern-gen-input').value.trim();
            if (!input) return;

            // Simple heuristic to create a regex from a log line
            // 1. Escape special characters
            let escap = input.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            // 2. Replace timestamps with rigid regex (e.g. <2026-02-09T...>)
            // <\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d{3})?Z?>
            escap = escap.replace(/&lt;\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.*?&gt;/g, '<.*?>'); // simplistic
            escap = escap.replace(/<\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.*?>/g, '<.*?>');

            // 3. Replace quoted strings if they look variable?
            // checking for "Something" -> "[^"]+"
            // Maybe safer to leave them unless user wants wildcards.

            // 4. Replace specific ID-like sequences?
            // matching hexadecimal hashes or long digits
            escap = escap.replace(/0x[0-9a-fA-F]+/g, '0x[0-9a-fA-F]+');

            // Output
            const output = document.getElementById('pattern-gen-output');
            output.value = escap;

            // Flash success
            output.style.borderColor = 'var(--success)';
            setTimeout(() => output.style.borderColor = 'rgba(255,255,255,0.1)', 500);
        }

        function copyGeneratedPattern() {
            const output = document.getElementById('pattern-gen-output');
            output.select();
            document.execCommand('copy');
            addDashItem('üìã', 'Pattern copied to clipboard');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SETTINGS: RECENT LOG SNIFFER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const recentLocations = [];

        function updateRecentLocations(line) {
            // Sniff location lines
            let match = line.match(/RoomName:\s*([^\s]+)/) || line.match(/Location\[([^\]]+)\]/);
            if (match) {
                const loc = match[1];
                // Avoid dupes
                if (!recentLocations.includes(loc)) {
                    recentLocations.unshift(loc);
                    if (recentLocations.length > 5) recentLocations.pop();
                    renderRecentLocations();
                }
            }
        }

        function renderRecentLocations() {
            const container = document.getElementById('recent-locs-container');
            if (!container) return; // Might need to add to HTML

            if (recentLocations.length === 0) {
                container.innerHTML = '<div style="font-style:italic; color:#555;">No recent locations detected...</div>';
                return;
            }

            container.innerHTML = recentLocations.map(loc => `
                  <div onclick="document.getElementById('new-loc-key').value='${loc}'; document.getElementById('new-loc-val').focus();" 
                       style="cursor:pointer; padding:4px; border-bottom:1px solid rgba(255,255,255,0.05); font-family:monospace; font-size:0.75rem; color:#aaa;">
                       ${loc} <span style="float:right; color:var(--accent);">Use ‚ûî</span>
                  </div>
             `).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SETTINGS: PATTERN MANAGER (Enhanced)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadBuiltinPatterns() {
            try {
                defaultPatterns = await ipcRenderer.invoke('settings:get-default-patterns');
                patternOverrides = await ipcRenderer.invoke('settings:get-pattern-overrides');
                renderBuiltinPatterns();
            } catch (e) {
                console.error('Failed to load patterns:', e);
            }
        }

        function renderBuiltinPatterns() {
            const list = document.getElementById('builtin-pattern-list');
            if (!list) return;
            list.innerHTML = '';

            const keys = Object.keys(defaultPatterns).sort();

            keys.forEach(key => {
                const config = patternOverrides[key] || {};
                const isDisabled = config.disabled;
                const currentRegex = config.regex || defaultPatterns[key];
                const defaultRegex = defaultPatterns[key]; // For reference
                const customMsg = config.message || '';

                // We don't easily know the "default message" unless we map it server-side, 
                // but we can at least show the regex clearly.

                const item = document.createElement('div');
                item.className = 'map-item';
                item.style.cssText = 'padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: var(--accent); font-weight: bold; font-family: monospace; font-size: 0.9rem;">${key}</span>
                        <label style="font-size: 0.8rem; cursor: pointer;">
                            <input type="checkbox" ${isDisabled ? '' : 'checked'} onchange="togglePattern('${key}', this.checked)"> Enabled
                        </label>
                    </div>
                    
                    <div style="font-size: 0.7rem; color: #888; margin-bottom: 2px;">Trigger Regex:</div>
                    <div style="font-family:monospace; font-size:0.7rem; color:#666; margin-bottom:2px;">Default: ${escapeHtml(defaultRegex.toString())}</div>
                    <input type="text" class="modern-input" style="width: 100%; font-family: monospace; font-size: 0.8rem; margin-bottom: 8px; color: #aaffaa;"
                        value="${escapeHtml(currentRegex.toString())}" 
                        onchange="updatePatternRegex('${key}', this.value)"
                        ${isDisabled ? 'disabled' : ''}
                        placeholder="Regex Pattern">
                    
                    <div style="font-size: 0.7rem; color: #888; margin-bottom: 2px;">Alert Message (Override):</div>
                    <input type="text" class="modern-input" style="width: 100%; font-size: 0.8rem;"
                        value="${escapeHtml(customMsg)}"
                        onchange="updatePatternMessage('${key}', this.value)"
                        ${isDisabled ? 'disabled' : ''}
                        placeholder="Leave empty to use system default...">
                `;
                list.appendChild(item);
            });
        }

        function saveNewCustomLocation() {
            const key = document.getElementById('new-loc-key').value.trim();
            const val = document.getElementById('new-loc-val').value.trim();
            const zone = document.getElementById('new-loc-zone').value;
            if (!key || !val) return alert('Please enter both a raw code and a friendly name.');

            const finalObj = zone === 'Auto' ? val : { name: val, zone: zone };
            customLocations[key] = finalObj;
            ipcRenderer.invoke('settings:save-custom-locations', customLocations);

            // Feedback
            addDashItem('‚úÖ', `Mapped <span style="color:#ffaa00; font-family:monospace;">${escapeHtml(key)}</span> ‚Üí <span style="color:#00ff88;">${escapeHtml(val)}</span>`);

            // Clear inputs
            document.getElementById('new-loc-key').value = '';
            document.getElementById('new-loc-val').value = '';
            document.getElementById('new-loc-zone').value = 'Auto';
            renderCustomLocationList();
        }

        function addCustomLocationPrompt() {
            document.getElementById('new-loc-key').focus();
        }

        window.deleteCustomLocation = function (key) {
            if (confirm(`Remove location mapping for "${key}"?`)) {
                delete customLocations[key];
                ipcRenderer.invoke('settings:save-custom-locations', customLocations);
                renderCustomLocationList();
                // Close modal if it was the edited one
                if (document.getElementById('location-edit-original-key').value === key) {
                    closeLocationSearchModal();
                }
            }
        };

        // ‚ïê‚ïê‚ïê CUSTOM LOCATION SEARCH & EDIT (New Feature) ‚ïê‚ïê‚ïê
        let locationSearchCache = {};
        let selectedLocationKey = null;

        function openLocationSearch() {
            locationSearchCache = { ...customLocations };
            selectedLocationKey = null;
            document.getElementById('location-search-input').value = '';
            document.getElementById('location-edit-panel').style.display = 'none';
            renderLocationSearchResults();
            document.getElementById('location-search-modal').style.display = 'flex';
        }

        function closeLocationSearchModal() {
            document.getElementById('location-search-modal').style.display = 'none';
            selectedLocationKey = null;
            document.getElementById('location-edit-panel').style.display = 'none';
        }

        function filterLocationSearch() {
            renderLocationSearchResults();
        }

        function clearLocationSearch() {
            document.getElementById('location-search-input').value = '';
            renderLocationSearchResults();
        }

        function renderLocationSearchResults() {
            const search = document.getElementById('location-search-input').value.toLowerCase();
            const resultsList = document.getElementById('location-search-results');

            // Filter locations
            let filtered = Object.entries(locationSearchCache).filter(([key, val]) => {
                const searchStr = typeof val === 'object' ? val.name : val;
                return key.toLowerCase().includes(search) || searchStr.toLowerCase().includes(search);
            });

            document.getElementById('location-search-count').textContent = filtered.length;

            if (filtered.length === 0) {
                resultsList.innerHTML = '<div style="color:#666; font-style:italic; text-align:center; padding:20px;">No locations match your search.</div>';
                return;
            }

            resultsList.innerHTML = filtered.map(([key, val]) => {
                const name = typeof val === 'object' ? val.name : val;
                const zone = typeof val === 'object' ? val.zone : 'Auto';
                const zoneBadge = zone !== 'Auto' ? `<span style="background:rgba(255,255,255,0.1); padding:2px 4px; border-radius:3px; font-size:0.6rem; margin-left:5px; color:#aaa;">${zone}</span>` : '';

                return `
                <div class="map-item" style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); 
                    cursor:pointer; border-radius:4px; transition:background 0.2s; background:${selectedLocationKey === key ? 'rgba(255,165,0,0.15)' : 'transparent'};"
                    onclick="selectLocationForEdit('${encodeURIComponent(key)}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="overflow:hidden; flex:1;">
                            <div style="font-family:monospace; color:var(--accent); font-size:0.8rem; font-weight:600;">${escapeHtml(key)}</div>
                            <div style="color:#00ff88; font-size:0.75rem; margin-top:2px;">‚ûî ${escapeHtml(name)}${zoneBadge}</div>
                        </div>
                        <button class="cyber-btn small" style="margin:0; margin-left:8px;" onclick="event.stopPropagation(); selectLocationForEdit('${encodeURIComponent(key)}')">
                            ‚úèÔ∏è
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function selectLocationForEdit(encodedKey) {
            const key = decodeURIComponent(encodedKey);
            const valObj = customLocations[key] || locationSearchCache[key]; // Fallback to cache if needed
            const val = typeof valObj === 'object' ? valObj.name : valObj;
            const zone = typeof valObj === 'object' ? valObj.zone || 'Auto' : 'Auto';

            selectedLocationKey = key;

            document.getElementById('location-edit-original-key').value = key;
            document.getElementById('location-edit-key').value = key;
            document.getElementById('location-edit-val').value = val;
            document.getElementById('location-edit-zone').value = zone;
            document.getElementById('location-edit-panel').style.display = 'block';
            renderLocationSearchResults(); // Re-render to show selection highlighting
        }

        function saveLocationEdit() {
            const originalKey = document.getElementById('location-edit-original-key').value;
            const newVal = document.getElementById('location-edit-val').value.trim();
            const newZone = document.getElementById('location-edit-zone').value;

            if (!newVal) {
                alert('Please enter a friendly name.');
                return;
            }

            // Delete old key if it was renamed
            if (selectedLocationKey !== originalKey) {
                delete customLocations[originalKey];
            }

            // Update with new value
            const finalObj = newZone === 'Auto' ? newVal : { name: newVal, zone: newZone };
            customLocations[selectedLocationKey] = finalObj;
            ipcRenderer.invoke('settings:save-custom-locations', customLocations);

            // Update both modal and main location list
            addDashItem('‚úÖ', `Updated: ${selectedLocationKey} ‚Üí ${escapeHtml(newVal)}`);
            renderCustomLocationList();
            closeLocationSearchModal();
        }

        function deleteSelectedLocation() {
            const key = document.getElementById('location-edit-original-key').value;
            if (confirm(`Delete location mapping "${key}"?`)) {
                window.deleteCustomLocation(key);
            }
        }

        function cancelLocationEdit() {
            document.getElementById('location-edit-panel').style.display = 'none';
            selectedLocationKey = null;
            renderLocationSearchResults();
        }

        // ‚ïê‚ïê‚ïê LOG PATTERN DATABASE (v2.7) ‚ïê‚ïê‚ïê
        let patternDB = { _meta: {}, patterns: [] };

        async function loadPatternDB() {
            try {
                patternDB = await ipcRenderer.invoke('patterns:load');
                renderPatternDB();
            } catch (e) {
                console.error('Failed to load pattern DB:', e);
            }
        }

        function renderPatternDB(filtered) {
            const patterns = filtered || patternDB.patterns;
            const list = document.getElementById('logdb-list');

            // Stats
            document.getElementById('logdb-total').textContent = patternDB.patterns.length;
            document.getElementById('logdb-verified').textContent = patternDB.patterns.filter(p => p.status === 'verified').length;
            document.getElementById('logdb-research').textContent = patternDB.patterns.filter(p => p.status === 'research').length;
            document.getElementById('logdb-updated').textContent = patternDB._meta.lastUpdated || '‚Äî';

            // Populate category filter
            const catSelect = document.getElementById('logdb-category');
            const currentCat = catSelect.value;
            const cats = [...new Set(patternDB.patterns.map(p => p.category))].sort();
            catSelect.innerHTML = '<option value="">All Categories</option>' +
                cats.map(c => `<option value="${c}" ${c === currentCat ? 'selected' : ''}>${c}</option>`).join('');

            if (patterns.length === 0) {
                list.innerHTML = '<div style="color:#555; font-style:italic; padding:30px; text-align:center;">No patterns found.</div>';
                return;
            }

            const categoryColors = {
                Vehicle: '#00c8ff', Navigation: '#00ff88', Combat: '#ff4444', Mission: '#ffa500',
                Hazard: '#ff6600', Session: '#aa88ff', Fire: '#ff2222', Inventory: '#888',
                Social: '#44aaff', Industrial: '#ffcc00', Other: '#666'
            };

            list.innerHTML = patterns.map(p => {
                const catColor = categoryColors[p.category] || '#888';
                const statusIcon = p.status === 'verified' ? '‚úÖ' : 'üî¨';
                const statusColor = p.status === 'verified' ? '#00ff88' : '#ffaa00';
                return `
                    <div style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); transition:background 0.2s;"
                         onmouseenter="this.style.background='rgba(255,165,0,0.05)'"
                         onmouseleave="this.style.background='transparent'">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <div style="display:flex; gap:8px; align-items:center;">
                                <span style="background:${catColor}22; color:${catColor}; padding:2px 6px; border-radius:3px;
                                    font-size:0.65rem; font-weight:700; letter-spacing:0.5px;">${escapeHtml(p.category)}</span>
                                <span style="font-weight:600; color:#eee; font-size:0.9rem;">${escapeHtml(p.name)}</span>
                                <span style="color:${statusColor}; font-size:0.7rem;">${statusIcon} ${p.status}</span>
                            </div>
                            <div style="display:flex; gap:4px;">
                                <button class="cyber-btn small" onclick="editPattern('${p.id}')" style="margin:0; font-size:0.65rem;">‚úèÔ∏è</button>
                                <button class="cyber-btn small" onclick="copyPatternRegex('${p.id}')" style="margin:0; font-size:0.65rem;">üìã</button>
                                ${p.source !== 'builtin' ? `<button class="cyber-btn small danger" onclick="deletePattern('${p.id}')" style="margin:0; font-size:0.65rem;">üóëÔ∏è</button>` : `<span style="font-size:0.6rem; color:#00c8ff; padding:2px 6px; background:rgba(0,200,255,0.1); border-radius:3px;">üîß BUILT-IN</span>`}
                            </div>
                        </div>
                        <div style="font-family:monospace; font-size:0.75rem; color:#aaffaa; background:rgba(0,0,0,0.3);
                            padding:4px 8px; border-radius:3px; margin-bottom:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            ${escapeHtml(p.regex)}
                        </div>
                        <div style="font-family:monospace; font-size:0.7rem; color:#bbb; background:rgba(0,0,0,0.2);
                            padding:3px 8px; border-radius:3px; margin-bottom:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            üìù ${escapeHtml(p.example || 'No example')}
                        </div>
                        <div style="display:flex; gap:10px; font-size:0.7rem; color:#888; margin-bottom:4px; flex-wrap:wrap;">
                            <span>Event: <b style="color:var(--accent);">${escapeHtml(p.event)}</b></span>
                            ${p.hue && p.hue !== 'none' ? `<span style="background:${p.hue}33; color:${p.hue === 'white' ? '#ccc' : p.hue}; padding:1px 5px; border-radius:3px; border:1px solid ${p.hue}55;">üé® ${p.hue.toUpperCase()}</span>` : ''}
                            ${p.overlay && p.overlay !== 'none' ? `<span style="background:rgba(0,200,255,0.1); color:#00c8ff; padding:1px 5px; border-radius:3px;">üì∫ ${p.overlay.toUpperCase()}</span>` : ''}
                            ${p.alert && p.alert !== 'none' ? `<span style="background:rgba(255,68,68,0.1); color:#ff4444; padding:1px 5px; border-radius:3px;">üñ•Ô∏è ${p.alert.toUpperCase()}</span>` : ''}
                            ${p.warning ? `<span style="background:rgba(255,165,0,0.1); color:#ffa500; padding:1px 5px; border-radius:3px;">‚ö†Ô∏è "${escapeHtml(p.warning)}"</span>` : ''}
                            ${p.reaction ? `<span style="background:rgba(170,136,255,0.1); color:#aa88ff; padding:1px 5px; border-radius:3px;">üì¢ ${escapeHtml(p.reaction)}</span>` : ''}
                        </div>
                        ${p.notes ? `<div style="font-size:0.7rem; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">üí¨ ${escapeHtml(p.notes)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterPatternDB() {
            const search = document.getElementById('logdb-search').value.toLowerCase();
            const cat = document.getElementById('logdb-category').value;
            const status = document.getElementById('logdb-status').value;

            let filtered = patternDB.patterns;
            if (search) {
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(search) ||
                    p.regex.toLowerCase().includes(search) ||
                    p.event.toLowerCase().includes(search) ||
                    (p.notes && p.notes.toLowerCase().includes(search)) ||
                    (p.example && p.example.toLowerCase().includes(search)) ||
                    (p.warning && p.warning.toLowerCase().includes(search)) ||
                    (p.reaction && p.reaction.toLowerCase().includes(search))
                );
            }
            if (cat) filtered = filtered.filter(p => p.category === cat);
            if (status) filtered = filtered.filter(p => p.status === status);

            renderPatternDB(filtered);
        }

        function showAddPatternModal() {
            document.getElementById('logdb-modal-title').textContent = 'Add Pattern';
            document.getElementById('pm-name').value = '';
            document.getElementById('pm-category').value = 'Other';
            document.getElementById('pm-event').value = '';
            document.getElementById('pm-status').value = 'research';
            document.getElementById('pm-regex').value = '';
            document.getElementById('pm-example').value = '';
            document.getElementById('pm-hue').value = '';
            document.getElementById('pm-overlay').value = 'none';
            document.getElementById('pm-alert').value = 'none';
            document.getElementById('pm-warning').value = '';
            document.getElementById('pm-reaction').value = '';
            document.getElementById('pm-notes').value = '';
            document.getElementById('pm-edit-id').value = '';
            document.getElementById('pm-test-result').textContent = 'Click Test to verify regex against example';
            document.getElementById('pm-test-result').style.color = '#666';
            document.getElementById('logdb-modal').style.display = 'flex';
        }

        function editPattern(id) {
            const p = patternDB.patterns.find(x => x.id === id);
            if (!p) return;
            document.getElementById('logdb-modal-title').textContent = 'Edit Pattern';
            document.getElementById('pm-name').value = p.name || '';
            document.getElementById('pm-category').value = p.category || 'Other';
            document.getElementById('pm-event').value = p.event || '';
            document.getElementById('pm-status').value = p.status || 'research';
            document.getElementById('pm-regex').value = p.regex || '';
            document.getElementById('pm-example').value = p.example || '';
            document.getElementById('pm-hue').value = p.hue || 'none';
            document.getElementById('pm-overlay').value = p.overlay || 'none';
            document.getElementById('pm-alert').value = p.alert || 'none';
            document.getElementById('pm-warning').value = p.warning || '';
            document.getElementById('pm-reaction').value = p.reaction || '';
            document.getElementById('pm-notes').value = p.notes || '';
            document.getElementById('pm-edit-id').value = id;
            document.getElementById('pm-test-result').textContent = 'Click Test to verify regex against example';
            document.getElementById('pm-test-result').style.color = '#666';
            document.getElementById('logdb-modal').style.display = 'flex';
        }

        function closePatternModal() {
            document.getElementById('logdb-modal').style.display = 'none';
        }

        async function savePatternFromModal() {
            const editId = document.getElementById('pm-edit-id').value;
            const data = {
                name: document.getElementById('pm-name').value.trim(),
                category: document.getElementById('pm-category').value,
                event: document.getElementById('pm-event').value.trim(),
                status: document.getElementById('pm-status').value,
                regex: document.getElementById('pm-regex').value.trim(),
                example: document.getElementById('pm-example').value.trim(),
                hue: document.getElementById('pm-hue').value,
                overlay: document.getElementById('pm-overlay').value,
                alert: document.getElementById('pm-alert').value,
                warning: document.getElementById('pm-warning').value.trim(),
                reaction: document.getElementById('pm-reaction').value.trim(),
                notes: document.getElementById('pm-notes').value.trim()
            };

            if (!data.name || !data.regex) {
                alert('Name and Regex are required.');
                return;
            }

            try {
                if (editId) {
                    patternDB = await ipcRenderer.invoke('patterns:update', editId, data);
                } else {
                    patternDB = await ipcRenderer.invoke('patterns:add', data);
                }
                closePatternModal();
                renderPatternDB();
                addDashItem('‚úÖ', `Pattern ${editId ? 'updated' : 'added'}: ${data.name}`);
            } catch (e) {
                console.error('Failed to save pattern:', e);
            }
        }

        async function deletePattern(id) {
            const p = patternDB.patterns.find(x => x.id === id);
            if (!p) return;
            if (!confirm(`Delete pattern "${p.name}"?`)) return;

            try {
                patternDB = await ipcRenderer.invoke('patterns:delete', id);
                renderPatternDB();
                addDashItem('üóëÔ∏è', `Deleted pattern: ${p.name}`);
            } catch (e) {
                console.error('Failed to delete pattern:', e);
            }
        }

        function copyPatternRegex(id) {
            const p = patternDB.patterns.find(x => x.id === id);
            if (!p) return;
            navigator.clipboard.writeText(p.regex)
                .then(() => addDashItem('üìã', `Copied regex for: ${p.name}`))
                .catch(() => addDashItem('‚ùå', 'Copy failed'));
        }

        function testPatternRegex() {
            const regex = document.getElementById('pm-regex').value;
            const example = document.getElementById('pm-example').value;
            const resultEl = document.getElementById('pm-test-result');

            if (!regex || !example) {
                resultEl.textContent = 'Enter both regex and example to test';
                resultEl.style.color = '#ffaa00';
                return;
            }

            try {
                const re = new RegExp(regex, 'i');
                const match = example.match(re);
                if (match) {
                    resultEl.style.color = '#00ff88';
                    if (match.length > 1) {
                        resultEl.textContent = `‚úÖ MATCH! Groups: [${match.slice(1).join(', ')}]`;
                    } else {
                        resultEl.textContent = '‚úÖ MATCH! (no capture groups)';
                    }
                } else {
                    resultEl.style.color = '#ff4444';
                    resultEl.textContent = '‚ùå NO MATCH ‚Äî regex does not match the example';
                }
            } catch (e) {
                resultEl.style.color = '#ff4444';
                resultEl.textContent = `‚ö†Ô∏è Invalid regex: ${e.message}`;
            }
        }

        async function exportPatternDB() {
            try {
                const path = await ipcRenderer.invoke('patterns:export');
                if (path) {
                    addDashItem('üì§', `Exported to: ${path}`);
                }
            } catch (e) {
                console.error('Export failed:', e);
            }
        }

        async function importPatternDB() {
            try {
                const result = await ipcRenderer.invoke('patterns:import');
                if (result && result.success) {
                    patternDB = await ipcRenderer.invoke('patterns:load');
                    renderPatternDB();
                    addDashItem('üì•', `Imported ${result.added} new patterns (${result.total} total)`);
                } else if (result && !result.success) {
                    addDashItem('‚ùå', `Import failed: ${result.error}`);
                }
            } catch (e) {
                console.error('Import failed:', e);
            }
        }

        function toggleHUDLock(unlock) {
            ipcRenderer.send('overlay:unlock', unlock);
            if (unlock) {
                addDashItem('üîß', 'HUD Unlocked ‚Äî Drag elements on overlay to move them');
            } else {
                addDashItem('üîí', 'HUD Locked ‚Äî Positions saved');
            }
        }

        function saveTeamNames() {
            const names = [
                document.getElementById('team-name-0').value || 'Alpha',
                document.getElementById('team-name-1').value || 'Bravo',
                document.getElementById('team-name-2').value || 'Charlie',
                document.getElementById('team-name-3').value || 'Delta'
            ];
            config.teamNames = names;
            saveConfig();
            updateTeamUIs();
        }

        function updateTeamUIs() {
            const names = config.teamNames || ['Alpha', 'Bravo', 'Charlie', 'Delta'];

            // Update Settings Inputs
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById(`team-name-${i}`);
                if (el) el.value = names[i];
            }

            // Update Target Dropdown
            const targetSelect = document.getElementById('cmd-target');
            if (targetSelect) {
                targetSelect.options[1].textContent = `üè∑Ô∏è ${names[0]}`; targetSelect.options[1].value = names[0].toUpperCase();
                targetSelect.options[2].textContent = `üè∑Ô∏è ${names[1]}`; targetSelect.options[2].value = names[1].toUpperCase();
                targetSelect.options[3].textContent = `üè∑Ô∏è ${names[2]}`; targetSelect.options[3].value = names[2].toUpperCase();
                targetSelect.options[4].textContent = `üè∑Ô∏è ${names[3]}`; targetSelect.options[4].value = names[3].toUpperCase();
            }

            // Update Your Team Dropdown
            const userTeamSelect = document.getElementById('config-user-team');
            if (userTeamSelect) {
                for (let i = 0; i < 4; i++) {
                    userTeamSelect.options[i].textContent = names[i];
                    userTeamSelect.options[i].value = names[i];
                }
            }
        }

        async function discoverHueBridge() {
            addDashItem('üîç', 'Searching for Hue Bridge...');
            const results = await ipcRenderer.invoke('hue:discover');
            if (results && results.length > 0) {
                const ip = results[0].internalipaddress;
                document.getElementById('config-hue-bridge').value = ip;
                addDashItem('üí°', `Bridge found at ${ip}`);
                saveConfig();
            } else {
                addDashItem('‚ùå', 'No Hue Bridge found on network');
            }
        }

        async function testHueLights() {
            const bridgeIp = document.getElementById('config-hue-bridge').value;
            const username = document.getElementById('config-hue-user').value;
            const lights = document.getElementById('config-hue-lights').value.split(',').map(l => l.trim());

            addDashItem('üß™', 'Testing Hue connection...');
            const res = await ipcRenderer.invoke('hue:control', {
                bridgeIp,
                username,
                lightId: lights,
                state: { on: true, alert: 'select' }
            });
            console.log('Hue Test Res:', res);
        }

        async function linkHueBridge() {
            const ip = document.getElementById('config-hue-bridge').value;
            if (!ip) return alert('Discover or enter Bridge IP first.');
            addDashItem('üîó', 'Attempting to link Bridge... (Press the physical button on Hue Bridge NOW!)');
            const res = await ipcRenderer.invoke('hue:link', ip);
            if (res && res[0] && res[0].success) {
                document.getElementById('config-hue-user').value = res[0].success.username;
                addDashItem('‚úÖ', 'Bridge Linked successfully!');
                saveConfig();
            } else if (res && res[0] && res[0].error) {
                addDashItem('‚ö†Ô∏è', 'Link failed: ' + res[0].error.description);
            }
        }

        function checkPlatformStatus() {
            // Pulse check broadcast-kit (running on 3000)
            fetch('http://localhost:3000/api/control/status')
                .then(r => r.json())
                .then(data => {
                    // Twitch
                    const tDot = document.getElementById('status-twitch-dot');
                    const tText = document.getElementById('status-twitch-text');
                    if (tDot) tDot.className = data.online ? 'dot on' : 'dot off';
                    if (tText) tText.textContent = data.online ? 'Connected' : 'Service Offline';

                    // YouTube (Added v2.9)
                    const yDot = document.getElementById('status-youtube-dot');
                    const yText = document.getElementById('status-youtube-text');
                    if (yDot) yDot.className = data.online ? 'dot on' : 'dot off';
                    if (yText) yText.textContent = data.online ? 'Connected' : 'Service Offline';
                })
                .catch(() => {
                    ['twitch', 'youtube'].forEach(p => {
                        const dot = document.getElementById('status-' + p + '-dot');
                        const text = document.getElementById('status-' + p + '-text');
                        if (dot) dot.className = 'dot off';
                        if (text) text.textContent = 'Service Offline';
                    });
                });
        }

        setInterval(checkPlatformStatus, 15000);
        checkPlatformStatus();

        async function refreshLocalIP() {
            const ip = await ipcRenderer.invoke('hue:get-ip');
            if (ip) {
                document.getElementById('local-ip').textContent = ip;
                document.getElementById('sidebar-local-ip').textContent = ip;
            }
        }

        ipcRenderer.on('hue:ip', (event, ip) => {
            document.getElementById('local-ip').textContent = ip;
            document.getElementById('sidebar-local-ip').textContent = ip;
        });

        // Init
        refreshLocalIP();
        loadBuiltinPatterns();
        loadCustomLocationList();
        loadPatternDB();
        updateTeamUIs();
    </script>
</body>

</html>